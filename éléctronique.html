<!DOCTYPE html>
<html lang="fr">
<head>
 <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<meta charset="UTF-8">
<title>Cybers√©curit√© - BAC PRO CIEL</title>
<style>
/* --- G√©n√©ral --- */
body {
 font-family: "Comic Neue", "Kristen ITC", "Chalkboard SE", sans-serif; 
 background: linear-gradient(#a6d6f7, #5c69d6, #0a1530);
 color: white;
 margin:0;
 line-height:1.6;
}

/* --- Menu d√©roulant --- */
.menu-bar { 
 background:#4a66ff; 
 padding:20px; 
 box-shadow:0 5px 15px rgba(0,0,0,0.3); 
}
.menu-bar ul { 
 list-style:none; 
 display:flex; 
 gap:25px; 
 justify-content:center; 
 margin:0; 
 padding:0; 
}
.menu-bar li { position:relative; }
.menu-bar a { 
 color:white; 
 text-decoration:none; 
 padding:15px 30px; 
 display:block; 
 border-radius:25px; 
 font-size:22px; 
 font-weight:bold;
 transition:0.3s; 
}
.menu-bar a:hover { 
 background:linear-gradient(135deg,#6e82ff,#8aa0ff);
}
.dropdown-content { 
 display:none; 
 position:absolute; 
 top:100%; left:0; 
 background:linear-gradient(#3550ff,#2c3b85); 
 min-width:200px; 
 border-radius:12px; 
 overflow:hidden; 
 z-index:1000; 
}
.dropdown-content a { 
 padding:15px 20px; 
 font-size:18px; 
}
.dropdown:hover .dropdown-content { display:block; }

/* --- Titres --- */
h1 { text-align:center; font-size:80px; margin-top:50px; letter-spacing:5px; }
h2 { text-align:center; font-size:50px; margin:30px 0 20px 0; }

/* --- Texte principal --- */
#mainText {
 width:80%; margin:0 auto 20px auto; font-size:22px; text-align:justify;
 padding:20px; background:#222; border-radius:20px; position:relative;
}
#likeMainBtn {
 position:absolute; top:10px; right:10px;
 background:#4a66ff; border:none; border-radius:12px; color:white; 
 padding:6px 12px; cursor:pointer; font-weight:bold; display:flex; gap:5px; align-items:center;
 transition:0.3s;
}
#likeMainBtn:hover { background:#6e82ff; transform:scale(1.05); }
#likeMainBtn.liked { background:#22c55e; transform:scale(1.1); }

/* --- Popups --- */
.login-popup {
 display:none;
 position:fixed;
 top:0; left:0;
 width:100%; height:100%;
 background:rgba(0,0,0,0.7);
 justify-content:center; 
 align-items:center;
 z-index:1000;
}
.login-popup.active {
 display:flex;
}
.login-popup form {
 background:#1a1a2e;
 padding:40px;
 border-radius:20px;
 display:flex;
 flex-direction:column;
 gap:20px;
 width:450px;
 max-height: 90vh;
 overflow-y: auto;
}
.login-popup input, .login-popup select, .login-popup textarea {
 padding:15px;
 border-radius:12px;
 border:none;
 font-size:18px;
}
.login-popup button {
 padding:12px;
 border-radius:15px;
 border:none;
 font-size:18px;
 cursor:pointer;
 background:#4a66ff;
 color:white;
 font-weight:bold;
}
.login-popup button:hover { background:#6e82ff; }

/* --- Section Commentaires --- */
#commentSection {
 width:80%; margin:0 auto 40px auto;
}
#commentSection form textarea {
 width:100%;
 padding:10px;
 margin-bottom:10px;
 border-radius:10px;
 border:none;
 font-size:18px;
 min-height: 80px;
 resize: vertical;
}
#commentSection form button {
 padding:12px;
 border-radius:12px;
 border:none;
 background:#4a66ff;
 color:white;
 font-size:18px;
 cursor:pointer;
}
#commentSection form button:hover { background:#6e82ff; }

/* --- Commentaires --- */
.comment, .reply {
 background:#222; padding:15px; border-radius:10px; margin-bottom:15px; position:relative;
}
.comment-header {
 display: flex;
 justify-content: space-between;
 align-items: center;
 margin-bottom: 10px;
}
.comment-author {
 font-weight: bold;
 color: #4a66ff;
}
.comment-date {
 font-size: 14px;
 color: #888;
}
.comment-text {
 margin: 10px 0;
}
.comment-actions {
 display: flex;
 gap: 10px;
 margin-top: 10px;
}
.likeBtn, .likeReplyBtn {
 background: #4a66ff;
 border: none;
 border-radius: 12px;
 color: white;
 padding: 6px 12px;
 cursor: pointer;
 font-weight: bold;
 display: inline-flex;
 align-items: center;
 gap: 5px;
 transition: all 0.3s ease;
}
.likeBtn:hover, .likeReplyBtn:hover { background: #6e82ff; transform: scale(1.05); }
.likeBtn.liked, .likeReplyBtn.liked { background: #22c55e; transform: scale(1.1); }
.replyBtn {
 background:#888; color:white; border:none; border-radius:8px; padding:6px 12px; cursor:pointer;
}
.replyBtn:hover { background:#aaa; }
.deleteBtn {
 background:#ff4444; color:white; border:none; border-radius:8px; padding:6px 12px; cursor:pointer;
}
.deleteBtn:hover { background:#ff6666; }

/* Replies container */
.replies-container {
 margin-left: 30px;
 margin-top: 15px;
}
.reply {
 background:#1a1a1a;
 padding:10px;
 border-left: 3px solid #4a66ff;
}

/* Reply form */
.reply-form {
 margin-left: 30px;
 margin-top: 10px;
 display: none;
}
.reply-form.active {
 display: block;
}
.reply-form textarea {
 width: 100%;
 padding: 8px;
 border-radius: 8px;
 border: none;
 margin-bottom: 5px;
 min-height: 60px;
}
.reply-form button {
 padding: 8px 15px;
 border-radius: 8px;
 border: none;
 background: #4a66ff;
 color: white;
 cursor: pointer;
 margin-right: 5px;
}
.reply-form button:hover {
 background: #6e82ff;
}
</style>
</head>
<body>

<header class="menu-bar">
  <ul>
    <li class="dropdown">
      <a href="index.html">Menu</a>
      <div class="dropdown-content">
        <a href="Cybers√©curit√©.html">Cybers√©curit√©</a>
        <a href="informatique.html">Informatique</a>
        <a href="√©l√©ctronique.html">√âlectronique</a>
      </div>
    </li>
    <li class="dropdown">
      <a href="profil.html">Compte</a>
      <div class="dropdown-content">
        <a href="#" id="signupBtn">Cr√©er un compte</a>
        <a href="#" id="loginBtn">Connexion</a>
        <a href="#" id="logoutBtn" style="display:none;">D√©connexion</a>
      </div>
    </li>
    <li class="dropdown">
      <a href="#">Information</a>
      <div class="dropdown-content">
        <a href="actualit√©.html">Cybers√©curit√©</a>
      </div>
    </li>
  </ul>
</header>

<!-- Popups Connexion/Cr√©ation -->
<div class="login-popup" id="loginForm">
    <form id="formLogin">
        <h2>Connexion</h2>
        <input type="text" id="loginUsername" placeholder="Nom d'utilisateur" required>
        <input type="password" id="loginPassword" placeholder="Mot de passe" required>
        <button type="submit">Se connecter</button>
        <button type="button" id="closeLogin">Fermer</button>
    </form>
</div>

<div class="login-popup" id="signupForm">
    <form id="formSignup">
        <h2>Cr√©er un compte</h2>
        <input type="text" id="signupPrenom" placeholder="Pr√©nom" required>
        <input type="text" id="signupNom" placeholder="Nom" required>
        <input type="email" id="signupEmail" placeholder="Email" required>
        <input type="text" id="signupUsername" placeholder="Nom d'utilisateur" required>
        <input type="password" id="signupPassword" placeholder="Mot de passe" required>
        <button type="submit">Cr√©er</button>
        <button type="button" id="closeSignup">Fermer</button>
    </form>
</div>

<!-- Contenu principal -->
<h1>BAC PRO CIEL</h1>
<h2>Le Bac Pro CIEL en √©lectronique</h2>
<div id="mainText">
  L'√©lectronique est au c≈ìur des technologies modernes.<br>
    Les √©l√®ves du Bac Pro CIEL √©tudient les composants √©lectroniques, les circuits, et le fonctionnement des syst√®mes √©lectroniques.<br>
    Ils apprennent √† concevoir, assembler et tester des dispositifs √©lectroniques,<br>
    √† lire des sch√©mas et √† d√©panner du mat√©riel.<br>
    Cette formation d√©veloppe √† la fois la compr√©hension th√©orique et les comp√©tences pratiques,<br>
    essentielles pour travailler dans des domaines tels que l'informatique embarqu√©e, la domotique ou les syst√®mes automatis√©s.
  
 <button id="likeMainBtn">üëç <span id="mainLikesCount">0</span></button>
</div>

<!-- Section Commentaires -->
<div id="commentSection">
    <h2>Commentaires</h2>
    <form id="commentForm">
        <textarea id="commentText" placeholder="√âcrire un commentaire..." required></textarea>
        <button type="submit">Poster</button>
    </form>
    <div id="commentsList"></div>
</div>

<script>
// ========================================
// CONFIGURATION SUPABASE
// ========================================
const SUPABASE_URL = 'https://TON_URL.supabase.co';
const SUPABASE_KEY = 'TON_ANON_KEY';
const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const PAGE_NAME = 'cybersecurite'; // Identifiant unique pour cette page

// ========================================
// R√âF√âRENCES √âL√âMENTS
// ========================================
const loginBtn = document.getElementById('loginBtn');
const signupBtn = document.getElementById('signupBtn');
const logoutBtn = document.getElementById('logoutBtn');
const closeLogin = document.getElementById('closeLogin');
const closeSignup = document.getElementById('closeSignup');
const loginForm = document.getElementById('loginForm');
const signupForm = document.getElementById('signupForm');
const likeMainBtn = document.getElementById('likeMainBtn');
const commentForm = document.getElementById('commentForm');
const commentsList = document.getElementById('commentsList');

let currentUser = null;
let isAdmin = false;

// ========================================
// GESTION UTILISATEUR
// ========================================
function getConnectedUserId() {
    return sessionStorage.getItem('connectedUserId');
}

async function loadCurrentUser() {
    const userId = getConnectedUserId();
    if (!userId) {
        loginBtn.style.display = 'inline-block';
        logoutBtn.style.display = 'none';
        return;
    }

    try {
        const { data: user, error } = await supabase
            .from('users')
            .select('*')
            .eq('id', userId)
            .single();

        if (error || !user) {
            currentUser = null;
            isAdmin = false;
            return;
        }

        currentUser = user;
        isAdmin = user.role === 'admin';
        loginBtn.style.display = 'none';
        logoutBtn.style.display = 'inline-block';

    } catch (err) {
        console.error('Erreur chargement utilisateur:', err);
    }
}

// ========================================
// POPUPS
// ========================================
loginBtn.addEventListener('click', (e) => {
    e.preventDefault();
    loginForm.classList.add('active');
});

signupBtn.addEventListener('click', (e) => {
    e.preventDefault();
    signupForm.classList.add('active');
});

closeLogin.addEventListener('click', () => {
    loginForm.classList.remove('active');
});

closeSignup.addEventListener('click', () => {
    signupForm.classList.remove('active');
});

loginForm.addEventListener('click', (e) => {
    if (e.target === loginForm) loginForm.classList.remove('active');
});

signupForm.addEventListener('click', (e) => {
    if (e.target === signupForm) signupForm.classList.remove('active');
});

// ========================================
// CONNEXION
// ========================================
document.getElementById('formLogin').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const username = document.getElementById('loginUsername').value.trim();
    const password = document.getElementById('loginPassword').value.trim();

    try {
        const { data: user, error } = await supabase
            .from('users')
            .select('*')
            .eq('username', username)
            .single();

        if (error || !user) {
            alert('Utilisateur inconnu !');
            return;
        }

        if (user.password !== password) {
            alert('Mot de passe incorrect !');
            return;
        }

        if (user.banned) {
            alert('Votre compte a √©t√© banni !');
            return;
        }

        sessionStorage.setItem('connectedUserId', user.id);
        alert(`Bienvenue ${user.prenom} !`);
        loginForm.classList.remove('active');
        await loadCurrentUser();
        await loadMainLikes();
        await loadComments();

    } catch (err) {
        console.error('Erreur connexion:', err);
        alert('Erreur lors de la connexion');
    }
});

// ========================================
// INSCRIPTION
// ========================================
document.getElementById('formSignup').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const prenom = document.getElementById('signupPrenom').value.trim();
    const nom = document.getElementById('signupNom').value.trim();
    const email = document.getElementById('signupEmail').value.trim();
    const username = document.getElementById('signupUsername').value.trim();
    const password = document.getElementById('signupPassword').value.trim();

    try {
        const { data: existing } = await supabase
            .from('users')
            .select('id')
            .eq('username', username)
            .single();

        if (existing) {
            alert('Ce nom d\'utilisateur existe d√©j√† !');
            return;
        }

        const { error } = await supabase
            .from('users')
            .insert([{
                prenom, nom, email, username, password,
                role: 'client'
            }]);

        if (error) {
            console.error('Erreur inscription:', error);
            alert('Erreur lors de la cr√©ation du compte');
            return;
        }

        alert('Compte cr√©√© avec succ√®s !');
        signupForm.classList.remove('active');
        document.getElementById('formSignup').reset();

    } catch (err) {
        console.error('Erreur inscription:', err);
        alert('Erreur lors de la cr√©ation du compte');
    }
});

// ========================================
// D√âCONNEXION
// ========================================
logoutBtn.addEventListener('click', () => {
    sessionStorage.removeItem('connectedUserId');
    location.reload();
});

// ========================================
// LIKE DU TEXTE PRINCIPAL
// ========================================
async function loadMainLikes() {
    try {
        const { count } = await supabase
            .from('main_text_likes')
            .select('*', { count: 'exact', head: true })
            .eq('page', PAGE_NAME);

        document.getElementById('mainLikesCount').textContent = count || 0;

        const userId = getConnectedUserId();
        if (userId) {
            const { data } = await supabase
                .from('main_text_likes')
                .select('id')
                .eq('page', PAGE_NAME)
                .eq('user_id', userId)
                .single();

            if (data) {
                likeMainBtn.classList.add('liked');
            }
        }
    } catch (err) {
        console.error('Erreur chargement likes:', err);
    }
}

likeMainBtn.addEventListener('click', async () => {
    const userId = getConnectedUserId();
    if (!userId) {
        alert('Vous devez √™tre connect√© pour liker');
        return;
    }

    try {
        const { data: existing } = await supabase
            .from('main_text_likes')
            .select('id')
            .eq('page', PAGE_NAME)
            .eq('user_id', userId)
            .single();

        if (existing) {
            // Supprimer le like
            await supabase
                .from('main_text_likes')
                .delete()
                .eq('id', existing.id);
                
            likeMainBtn.classList.remove('liked');
        } else {
            // Ajouter le like
            await supabase
                .from('main_text_likes')
                .insert([{
                    page: PAGE_NAME,
                    user_id: userId
                }]);
                
            likeMainBtn.classList.add('liked');
        }

        await loadMainLikes();

    } catch (err) {
        console.error('Erreur like:', err);
        alert('Erreur lors du like');
    }
});

// ========================================
// COMMENTAIRES
// ========================================
commentForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const userId = getConnectedUserId();
    if (!userId) {
        alert('Vous devez √™tre connect√© pour commenter');
        return;
    }

    const text = document.getElementById('commentText').value.trim();
    if (!text) return;

    try {
        await supabase
            .from('comments')
            .insert([{
                text: text,
                user_id: userId,
                username: currentUser.username,
                actualite_id: null // null car c'est un commentaire de page
            }]);

        document.getElementById('commentText').value = '';
        await loadComments();

    } catch (err) {
        console.error('Erreur ajout commentaire:', err);
        alert('Erreur lors de l\'ajout du commentaire');
    }
});

async function loadComments() {
    try {
        const { data: comments, error } = await supabase
            .from('comments')
            .select('*')
            .is('actualite_id', null)
            .eq('hidden', false)
            .order('created_at', { ascending: false });

        if (error) {
            console.error('Erreur chargement commentaires:', error);
            return;
        }

        commentsList.innerHTML = '';

        for (const comment of comments) {
            const commentDiv = await createCommentElement(comment);
            commentsList.appendChild(commentDiv);
        }

    } catch (err) {
        console.error('Erreur chargement commentaires:', err);
    }
}

async function createCommentElement(comment) {
    const div = document.createElement('div');
    div.className = 'comment';
    
    const likesCount = await getCommentLikesCount(comment.id);
    const isLiked = await checkIfCommentLiked(comment.id);
    
    const date = new Date(comment.created_at).toLocaleString('fr-FR');
    
    const deleteButton = (isAdmin || (currentUser && currentUser.id === comment.user_id)) 
        ? `<button class="deleteBtn" onclick="deleteComment('${comment.id}')">Supprimer</button>` 
        : '';
    
    div.innerHTML = `
        <div class="comment-header">
            <span class="comment-author">${comment.username}</span>
            <span class="comment-date">${date}</span>
        </div>
        <div class="comment-text">${comment.text}</div>
        <div class="comment-actions">
            <button class="likeBtn ${isLiked ? 'liked' : ''}" onclick="toggleLikeComment('${comment.id}')">
                üëç <span id="comment-likes-${comment.id}">${likesCount}</span>
            </button>
            <button class="replyBtn" onclick="showReplyForm('${comment.id}')">R√©pondre</button>
            ${deleteButton}
        </div>
        <div class="reply-form" id="reply-form-${comment.id}">
            <textarea id="reply-text-${comment.id}" placeholder="√âcrire une r√©ponse..."></textarea>
            <button onclick="submitReply('${comment.id}')">Envoyer</button>
            <button onclick="hideReplyForm('${comment.id}')">Annuler</button>
        </div>
        <div class="replies-container" id="replies-${comment.id}"></div>
    `;
    
    // Charger les r√©ponses
    await loadReplies(comment.id);
    
    return div;
}

// ========================================
// LIKES COMMENTAIRES
// ========================================
async function getCommentLikesCount(commentId) {
    try {
        const { count } = await supabase
            .from('comment_likes')
            .select('*', { count: 'exact', head: true })
            .eq('comment_id', commentId);
        return count || 0;
    } catch (err) {
        return 0;
    }
}

async function checkIfCommentLiked(commentId) {
    const userId = getConnectedUserId();
    if (!userId) return false;
    
    try {
        const { data } = await supabase
            .from('comment_likes')
            .select('id')
            .eq('comment_id', commentId)
            .eq('user_id', userId)
            .single();
        return !!data;
    } catch (err) {
        return false;
    }
}

async function toggleLikeComment(commentId) {
    const userId = getConnectedUserId();
    if (!userId) {
        alert('Vous devez √™tre connect√© pour liker');
        return;
    }
    
    try {
        const { data: existing } = await supabase
            .from('comment_likes')
            .select('id')
            .eq('comment_id', commentId)
            .eq('user_id', userId)
            .single();

        if (existing) {
            await supabase
                .from('comment_likes')
                .delete()
                .eq('id', existing.id);
        } else {
            await supabase
                .from('comment_likes')
                .insert([{
                    comment_id: commentId,
                    user_id: userId
                }]);
        }

        await loadComments();

    } catch (err) {
        console.error('Erreur like commentaire:', err);
        alert('Erreur lors du like');
    }
}

// ========================================
// R√âPONSES AUX COMMENTAIRES
// ========================================
function showReplyForm(commentId) {
    if (!getConnectedUserId()) {
        alert('Vous devez √™tre connect√© pour r√©pondre');
        return;
    }
    document.getElementById(`reply-form-${commentId}`).classList.add('active');
}

function hideReplyForm(commentId) {
    document.getElementById(`reply-form-${commentId}`).classList.remove('active');
}

async function submitReply(commentId) {
    const userId = getConnectedUserId();
    if (!userId) return;
    
    const text = document.getElementById(`reply-text-${commentId}`).value.trim();
    if (!text) return;
    
    try {
        await supabase
            .from('replies')
            .insert([{
                comment_id: commentId,
                user_id: userId,
                username: currentUser.username,
                text: text
            }]);

        hideReplyForm(commentId);
        await loadComments();

    } catch (err) {
        console.error('Erreur ajout r√©ponse:', err);
        alert('Erreur lors de l\'ajout de la r√©ponse');
    }
}

async function loadReplies(commentId) {
    try {
        const { data: replies, error } = await supabase
            .from('replies')
            .select('*')
            .eq('comment_id', commentId)
            .order('created_at', { ascending: true });

        if (error) return;

        const repliesContainer = document.getElementById(`replies-${commentId}`);
        repliesContainer.innerHTML = '';

        for (const reply of replies) {
            const replyDiv = await createReplyElement(reply);
            repliesContainer.appendChild(replyDiv);
        }

    } catch (err) {
        console.error('Erreur chargement r√©ponses:', err);
    }
}

async function createReplyElement(reply) {
    const div = document.createElement('div');
    div.className = 'reply';
    
    const likesCount = await getReplyLikesCount(reply.id);
    const isLiked = await checkIfReplyLiked(reply.id);
    
    const date = new Date(reply.created_at).toLocaleString('fr-FR');
    
    const deleteButton = (isAdmin || (currentUser && currentUser.id === reply.user_id)) 
        ? `<button class="deleteBtn" onclick="deleteReply('${reply.id}', '${reply.comment_id}')">Supprimer</button>` 
        : '';
    
    div.innerHTML = `
        <div class="comment-header">
            <span class="comment-author">${reply.username}</span>
            <span class="comment-date">${date}</span>
        </div>
        <div class="comment-text">${reply.text}</div>
        <div class="comment-actions">
            <button class="likeReplyBtn ${isLiked ? 'liked' : ''}" onclick="toggleLikeReply('${reply.id}')">
                üëç <span id="reply-likes-${reply.id}">${likesCount}</span>
            </button>
            ${deleteButton}
        </div>
    `;
    
    return div;
}

// ========================================
// LIKES R√âPONSES
// ========================================
async function getReplyLikesCount(replyId) {
    try {
        const { count } = await supabase
            .from('reply_likes')
            .select('*', { count: 'exact', head: true })
            .eq('reply_id', replyId);
        return count || 0;
    } catch (err) {
        return 0;
    }
}

async function checkIfReplyLiked(replyId) {
    const userId = getConnectedUserId();
    if (!userId) return false;
    
    try {
        const { data } = await supabase
            .from('reply_likes')
            .select('id')
            .eq('reply_id', replyId)
            .eq('user_id', userId)
            .single();
        return !!data;
    } catch (err) {
        return false;
    }
}

async function toggleLikeReply(replyId) {
    const userId = getConnectedUserId();
    if (!userId) {
        alert('Vous devez √™tre connect√© pour liker');
        return;
    }
    
    try {
        const { data: existing } = await supabase
            .from('reply_likes')
            .select('id')
            .eq('reply_id', replyId)
            .eq('user_id', userId)
            .single();

        if (existing) {
            await supabase
                .from('reply_likes')
                .delete()
                .eq('id', existing.id);
        } else {
            await supabase
                .from('reply_likes')
                .insert([{
                    reply_id: replyId,
                    user_id: userId
                }]);
        }

        await loadComments();

    } catch (err) {
        console.error('Erreur like r√©ponse:', err);
        alert('Erreur lors du like');
    }
}

// ========================================
// SUPPRESSION
// ========================================
async function deleteComment(commentId) {
    if (!confirm('Supprimer ce commentaire ?')) return;
    
    try {
        await supabase
            .from('comments')
            .delete()
            .eq('id', commentId);

        await loadComments();

    } catch (err) {
        console.error('Erreur suppression commentaire:', err);
        alert('Erreur lors de la suppression');
    }
}

async function deleteReply(replyId, commentId) {
    if (!confirm('Supprimer cette r√©ponse ?')) return;
    
    try {
        await supabase
            .from('replies')
            .delete()
            .eq('id', replyId);

        await loadComments();

    } catch (err) {
        console.error('Erreur suppression r√©ponse:', err);
        alert('Erreur lors de la suppression');
    }
}

// ========================================
// CHARGEMENT INITIAL
// ========================================
window.onload = async () => {
    await loadCurrentUser();
    await loadMainLikes();
    await loadComments();
};
</script>

</body>
</html>

