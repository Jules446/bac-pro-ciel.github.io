<!DOCTYPE html>
<html lang="fr">
<head>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<meta charset="UTF-8">
<title>Profil Utilisateur</title>
<style>
body {
   font-family: "Comic Neue", "Kristen ITC", "Chalkboard SE", sans-serif;
    background: linear-gradient(#a6d6f7, #5c69d6, #0a1530);
    color:#fff;
    margin:0;
    min-height:100vh;
}

.menu-bar { 
    background:#4a66ff; 
    padding:20px; 
    box-shadow:0 5px 15px rgba(0,0,0,0.3); 
}
.menu-bar ul { 
    list-style:none; 
    display:flex; 
    gap:25px; 
    justify-content:center; 
    margin:0; 
    padding:0; 
}
.menu-bar li { position:relative; }
.menu-bar a { 
    color:white; 
    text-decoration:none; 
    padding:15px 30px; 
    display:block; 
    border-radius:25px; 
    font-size:22px; 
    font-weight:bold;
    transition:0.3s; 
}
.menu-bar a:hover { 
    background:linear-gradient(135deg,#6e82ff,#8aa0ff);
}
.dropdown-content { 
    display:none; 
    position:absolute; 
    top:100%; left:0; 
    background:linear-gradient(#3550ff,#2c3b85); 
    min-width:200px; 
    border-radius:12px; 
    overflow:hidden; 
    z-index:1000; 
}
.dropdown-content a { 
    padding:15px 20px; 
    font-size:18px; 
}
.dropdown:hover .dropdown-content { display:block; }

.profile-container {
    max-width:600px;
    margin:50px auto;
    background:#0f1a3a;
    padding:30px;
    border-radius:20px;
    box-shadow:0 0 25px #4a66ff;
    text-align:center;
}
.profile-container img {
    width:150px;
    height:150px;
    border-radius:50%;
    object-fit:cover;
    border:3px solid #4a66ff;
    margin-bottom:20px;
}
.profile-container p { font-size:20px; margin:10px 0;}
.btn-action {
    display:inline-block;
    padding:12px 25px;
    border-radius:25px;
    background:#4a66ff;
    color:#fff;
    border:none;
    cursor:pointer;
    margin:5px;
    font-size:18px;
    font-weight:bold;
    transition:0.2s;
}
.btn-action:hover { background:#6e82ff; }

.popup {
    display:none;
    position:fixed;
    top:0; left:0;
    width:100%; height:100%;
    background:rgba(0,0,0,0.7);
    justify-content:center; align-items:center;
    z-index:1000;
}
.popup form {
    background:#1a1a2e;
    padding:30px;
    border-radius:20px;
    display:flex;
    flex-direction:column;
    gap:15px;
    width:400px;
}
.popup input { padding:10px; border-radius:10px; border:none; font-size:16px;}
.popup button {
    padding:12px;
    border-radius:15px;
    border:none;
    cursor:pointer;
    background:#4a66ff;
    color:#fff;
    font-weight:bold;
    font-size:16px;
}
.popup button:hover { background:#6e82ff;}
</style>
</head>
<body>

<header class="menu-bar">
  <ul>
    <li class="dropdown">
      <a href="index.html">Menu</a>
      <div class="dropdown-content">
        <a href="Cybersécurité.html">Cybersécurité</a>
        <a href="informatique.html">Informatique</a>
        <a href="éléctronique.html">Électronique</a>
      </div>
    </li>
    <li class="dropdown">
      <a href="profil.html">Compte</a>
      <div class="dropdown-content">
        <a href="#" id="signupBtn">Créer un compte</a>
        <a href="#" id="loginBtn">Connexion</a>
        <a href="#" id="logoutBtn" style="display:none;">Déconnexion</a>
      </div>
    </li>
    <li class="dropdown">
        <a href="#">Information</a>
        <div class="dropdown-content">
            <a href="actualité.html">Cybersécurité</a>
        </div>
    </li>
  </ul>
</header>

<div class="profile-container" id="profileContainer">
    <img id="profilePic" src="https://via.placeholder.com/150" alt="Photo de profil">
    <p><strong>Prénom:</strong> <span id="profilPrenom"></span></p>
    <p><strong>Nom:</strong> <span id="profilNom"></span></p>
    <p><strong>Email:</strong> <span id="profilEmail"></span></p>
    <p><strong>Date de naissance:</strong> <span id="profilDob"></span></p>
    <p><strong>Nom d'utilisateur:</strong> <span id="profilUsername"></span></p>
    <button class="btn-action" id="editProfileBtn">Modifier mon profil</button>
    <button class="btn-action" id="logoutBtnProfile">Déconnexion</button>
</div>

<div class="popup" id="editPopup">
    <form id="editForm">
        <h2 style="text-align:center;color:white;">Modifier le profil</h2>
        <input type="text" id="editPrenom" placeholder="Prénom">
        <input type="text" id="editNom" placeholder="Nom">
        <input type="email" id="editEmail" placeholder="Email">
        <input type="date" id="editDob" placeholder="Date de naissance">
        <input type="password" id="editPassword" placeholder="Nouveau mot de passe (optionnel)">
        <input type="file" id="editPhoto" accept="image/*">
        <button type="submit">Enregistrer</button>
        <button type="button" id="closePopup">Annuler</button>
    </form>
</div>

<div class="popup" id="loginPopup">
    <form id="loginPopupForm">
        <h2 style="text-align:center;color:white;">Connexion requise</h2>
        <input type="text" id="popupUsername" placeholder="Nom d'utilisateur">
        <input type="password" id="popupPassword" placeholder="Mot de passe">
        <button type="submit">Se connecter</button>
    </form>
</div>

<script>
const SUPABASE_URL = 'https://bvtzijciriawuajyzovs.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ2dHppamNpcmlhd3Vhanl6b3ZzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5NDM5MzksImV4cCI6MjA4MTUxOTkzOX0.bwECe_OuAKAy-lT73DqTwv91UufDxsgqXxds4sNtRxw';
const { createClient } = supabase;
const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const profilPrenom = document.getElementById('profilPrenom');
const profilNom = document.getElementById('profilNom');
const profilEmail = document.getElementById('profilEmail');
const profilDob = document.getElementById('profilDob');
const profilUsername = document.getElementById('profilUsername');
const profilePic = document.getElementById('profilePic');
const editProfileBtn = document.getElementById('editProfileBtn');
const editPopup = document.getElementById('editPopup');
const closePopup = document.getElementById('closePopup');
const editForm = document.getElementById('editForm');
const logoutBtnProfile = document.getElementById('logoutBtnProfile');
const editPhotoInput = document.getElementById('editPhoto');
const loginPopup = document.getElementById('loginPopup');

async function getSession() {
    const { data: { session } } = await supabaseClient.auth.getSession();
    return session;
}

async function getCurrentProfile() {
    const session = await getSession();
    if (!session) return null;

    const { data: profile } = await supabaseClient
        .from('profiles')
        .select('*')
        .eq('id', session.user.id)
        .single();

    return profile;
}

async function loadUserProfile() {
    const profile = await getCurrentProfile();
    
    if (!profile) {
        loginPopup.style.display = 'flex';
        return;
    }

    updateProfileDisplay(profile);
}

function updateProfileDisplay(profile) {
    profilPrenom.textContent = profile.prenom || '';
    profilNom.textContent = profile.nom || '';
    profilEmail.textContent = profile.email || '';
    profilDob.textContent = profile.dob ? new Date(profile.dob).toLocaleDateString('fr-FR') : '';
    profilUsername.textContent = profile.username || '';
    profilePic.src = profile.photo || "https://via.placeholder.com/150";
}

editProfileBtn.onclick = async () => {
    const profile = await getCurrentProfile();
    if (!profile) return;
    
    editPopup.style.display = 'flex';
    document.getElementById('editPrenom').value = profile.prenom || '';
    document.getElementById('editNom').value = profile.nom || '';
    document.getElementById('editEmail').value = profile.email || '';
    document.getElementById('editDob').value = profile.dob || '';
    document.getElementById('editPassword').value = '';
    editPhotoInput.value = '';
};

closePopup.onclick = () => { 
    editPopup.style.display = 'none'; 
};

editPhotoInput.onchange = function(e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(evt) { 
            profilePic.src = evt.target.result; 
        };
        reader.readAsDataURL(file);
    }
};

editForm.onsubmit = async (e) => {
    e.preventDefault();
    
    const session = await getSession();
    if (!session) return;

    const updates = {};
    
    const newPrenom = document.getElementById('editPrenom').value.trim();
    const newNom = document.getElementById('editNom').value.trim();
    const newEmail = document.getElementById('editEmail').value.trim();
    const newDob = document.getElementById('editDob').value;
    const newPassword = document.getElementById('editPassword').value.trim();

    if (newPrenom) updates.prenom = newPrenom;
    if (newNom) updates.nom = newNom;
    if (newEmail) updates.email = newEmail;
    if (newDob) updates.dob = newDob;

    const file = editPhotoInput.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = async function(evt) {
            updates.photo = evt.target.result;
            await saveProfile(updates, newPassword);
        };
        reader.readAsDataURL(file);
    } else {
        await saveProfile(updates, newPassword);
    }
};

async function saveProfile(updates, newPassword) {
    try {
        const session = await getSession();
        if (!session) return;

        const { error: profileError } = await supabaseClient
            .from('profiles')
            .update(updates)
            .eq('id', session.user.id);

        if (profileError) {
            console.error('Erreur profil:', profileError);
            alert('Erreur lors de la mise à jour du profil');
            return;
        }

        if (newPassword) {
            const { error: pwdError } = await supabaseClient.auth.updateUser({
                password: newPassword
            });

            if (pwdError) {
                console.error('Erreur mot de passe:', pwdError);
                alert('Profil mis à jour mais erreur mot de passe');
            }
        }

        alert('Profil mis à jour avec succès !');
        editPopup.style.display = 'none';
        await loadUserProfile();

    } catch (err) {
        console.error('Erreur:', err);
        alert('Erreur : ' + err.message);
    }
}

logoutBtnProfile.onclick = async () => {
    await supabaseClient.auth.signOut();
    window.location.href = "index.html";
};

document.getElementById('loginPopupForm').onsubmit = async (e) => {
    e.preventDefault();
    
    const username = document.getElementById('popupUsername').value.trim();
    const password = document.getElementById('popupPassword').value.trim();

    try {
        const { data: profile, error: profileError } = await supabaseClient
            .from('profiles')
            .select('email, banned')
            .eq('username', username)
            .single();

        if (profileError || !profile) {
            alert('Utilisateur non trouvé !');
            return;
        }

        if (profile.banned) {
            alert('Votre compte a été banni !');
            return;
        }

        const { error: authError } = await supabaseClient.auth.signInWithPassword({
            email: profile.email,
            password: password
        });

        if (authError) {
            alert('Mot de passe incorrect !');
            return;
        }

        loginPopup.style.display = 'none';
        await loadUserProfile();

    } catch (err) {
        console.error('Erreur connexion:', err);
        alert('Erreur : ' + err.message);
    }
};

window.onload = async () => {
    await loadUserProfile();
};
</script>

</body>
</html>
