<!DOCTYPE html>
<html lang="fr">
<head>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<meta charset="UTF-8">
<title>Profil Utilisateur</title>
<style>
body {
   font-family: "Comic Neue", "Kristen ITC", "Chalkboard SE", sans-serif;
    background: linear-gradient(#a6d6f7, #5c69d6, #0a1530);
    color:#fff;
    margin:0;
    min-height:100vh;
}

/* --- Menu déroulant --- */
.menu-bar { 
    background:#4a66ff; 
    padding:20px; 
    box-shadow:0 5px 15px rgba(0,0,0,0.3); 
}
.menu-bar ul { 
    list-style:none; 
    display:flex; 
    gap:25px; 
    justify-content:center; 
    margin:0; 
    padding:0; 
}
.menu-bar li { position:relative; }
.menu-bar a { 
    color:white; 
    text-decoration:none; 
    padding:15px 30px; 
    display:block; 
    border-radius:25px; 
    font-size:22px; 
    font-weight:bold;
    transition:0.3s; 
}
.menu-bar a:hover { 
    background:linear-gradient(135deg,#6e82ff,#8aa0ff);
}
.dropdown-content { 
    display:none; 
    position:absolute; 
    top:100%; left:0; 
    background:linear-gradient(#3550ff,#2c3b85); 
    min-width:200px; 
    border-radius:12px; 
    overflow:hidden; 
    z-index:1000; 
}
.dropdown-content a { 
    padding:15px 20px; 
    font-size:18px; 
}
.dropdown:hover .dropdown-content { display:block; }

/* --- Profil --- */
.profile-container {
    max-width:600px;
    margin:50px auto;
    background:#0f1a3a;
    padding:30px;
    border-radius:20px;
    box-shadow:0 0 25px #4a66ff;
    text-align:center;
}
.profile-container img {
    width:150px;
    height:150px;
    border-radius:50%;
    object-fit:cover;
    border:3px solid #4a66ff;
    margin-bottom:20px;
}
.profile-container p { font-size:20px; margin:10px 0;}
.btn-action {
    display:inline-block;
    padding:12px 25px;
    border-radius:25px;
    background:#4a66ff;
    color:#fff;
    border:none;
    cursor:pointer;
    margin:5px;
    font-size:18px;
    font-weight:bold;
    transition:0.2s;
}
.btn-action:hover { background:#6e82ff; }

/* --- Popup --- */
.popup {
    display:none;
    position:fixed;
    top:0; left:0;
    width:100%; height:100%;
    background:rgba(0,0,0,0.7);
    justify-content:center; align-items:center;
    z-index:1000;
}
.popup form {
    background:#1a1a2e;
    padding:30px;
    border-radius:20px;
    display:flex;
    flex-direction:column;
    gap:15px;
    width:400px;
}
.popup input { padding:10px; border-radius:10px; border:none; font-size:16px;}
.popup button {
    padding:12px;
    border-radius:15px;
    border:none;
    cursor:pointer;
    background:#4a66ff;
    color:#fff;
    font-weight:bold;
    font-size:16px;
}
.popup button:hover { background:#6e82ff;}
</style>
</head>
<body>

<!-- Menu -->
<header class="menu-bar">
  <ul>
    <li class="dropdown">
      <a href="index.html">Menu</a>
      <div class="dropdown-content">
        <a href="Cybersécurité.html">Cybersécurité</a>
        <a href="informatique.html">Informatique</a>
        <a href="éléctronique.html">Électronique</a>
      </div>
    </li>
    <li class="dropdown">
      <a href="profil.html">Compte</a>
      <div class="dropdown-content">
        <a href="#" id="signupBtn">Créer un compte</a>
        <a href="#" id="loginBtn">Connexion</a>
        <a href="#" id="logoutBtn" style="display:none;">Déconnexion</a>
      </div>
    </li>
    <li class="dropdown">
        <a href="#">Information</a>
        <div class="dropdown-content">
            <a href="actualité.html">Cybersécurité</a>
        </div>
    </li>
  </ul>
</header>

<!-- --- Profil utilisateur --- -->
<div class="profile-container" id="profileContainer">
    <img id="profilePic" src="https://via.placeholder.com/150" alt="Photo de profil">
    <p><strong>Prénom:</strong> <span id="profilPrenom"></span></p>
    <p><strong>Nom:</strong> <span id="profilNom"></span></p>
    <p><strong>Email:</strong> <span id="profilEmail"></span></p>
    <p><strong>Date de naissance:</strong> <span id="profilDob"></span></p>
    <p><strong>Nom d'utilisateur:</strong> <span id="profilUsername"></span></p>
    <button class="btn-action" id="editProfileBtn">Modifier mon profil</button>
    <button class="btn-action" id="logoutBtnProfile">Déconnexion</button>
</div>

<!-- --- Popup modifier profil --- -->
<div class="popup" id="editPopup">
    <form id="editForm">
        <h2 style="text-align:center;color:white;">Modifier le profil</h2>
        <input type="text" id="editPrenom" placeholder="Prénom">
        <input type="text" id="editNom" placeholder="Nom">
        <input type="email" id="editEmail" placeholder="Email">
        <input type="date" id="editDob" placeholder="Date de naissance">
        <input type="password" id="editPassword" placeholder="Nouveau mot de passe (optionnel)">
        <input type="file" id="editPhoto" accept="image/*">
        <button type="submit">Enregistrer</button>
        <button type="button" id="closePopup">Annuler</button>
    </form>
</div>

<!-- --- Popup connexion si pas connecté --- -->
<div class="popup" id="loginPopup">
    <form id="loginPopupForm">
        <h2 style="text-align:center;color:white;">Connexion requise</h2>
        <input type="text" id="popupUsername" placeholder="Nom d'utilisateur">
        <input type="password" id="popupPassword" placeholder="Mot de passe">
        <button type="submit">Se connecter</button>
    </form>
</div>

<script>
// ========================================
// CONFIGURATION SUPABASE - VERSION CORRIGÉE
// ========================================
const SUPABASE_URL = 'https://bvtzijciriawuajyzovs.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ2dHppamNpcmlhd3Vhanl6b3ZzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5NDM5MzksImV4cCI6MjA4MTUxOTkzOX0.bwECe_OuAKAy-lT73DqTwv91UufDxsgqXxds4sNtRxw'; // ⚠️ Remplacer par votre clé anon
const { createClient } = supabase;
const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
// ========================================
// RÉFÉRENCES ÉLÉMENTS DOM
// ========================================
const profilPrenom = document.getElementById('profilPrenom');
const profilNom = document.getElementById('profilNom');
const profilEmail = document.getElementById('profilEmail');
const profilDob = document.getElementById('profilDob');
const profilUsername = document.getElementById('profilUsername');
const profilePic = document.getElementById('profilePic');
const editProfileBtn = document.getElementById('editProfileBtn');
const editPopup = document.getElementById('editPopup');
const closePopup = document.getElementById('closePopup');
const editForm = document.getElementById('editForm');
const logoutBtnProfile = document.getElementById('logoutBtnProfile');
const editPhotoInput = document.getElementById('editPhoto');
const loginPopup = document.getElementById('loginPopup');

let currentUser = null;

// ========================================
// RÉCUPÉRATION UTILISATEUR CONNECTÉ
// ========================================
function getConnectedUserId() {
    return sessionStorage.getItem('connectedUserId');
}

// ========================================
// CHARGEMENT PROFIL
// ========================================
async function loadUserProfile() {
    const userId = getConnectedUserId();
    
    if (!userId) {
        // Pas connecté, afficher popup de connexion
        loginPopup.style.display = 'flex';
        return;
    }

    try {
        // Récupérer les données de l'utilisateur
        const { data: user, error } = await supabase
            .from('users')
            .select('*')
            .eq('id', userId)
            .single();

        if (error || !user) {
            console.error('Erreur chargement profil:', error);
            alert('Erreur lors du chargement du profil');
            sessionStorage.removeItem('connectedUserId');
            loginPopup.style.display = 'flex';
            return;
        }

        currentUser = user;
        updateProfileDisplay(user);

    } catch (err) {
        console.error('Erreur:', err);
        alert('Erreur lors du chargement du profil');
    }
}

// ========================================
// MISE À JOUR AFFICHAGE PROFIL
// ========================================
function updateProfileDisplay(user) {
    profilPrenom.textContent = user.prenom || '';
    profilNom.textContent = user.nom || '';
    profilEmail.textContent = user.email || '';
    profilDob.textContent = user.dob ? new Date(user.dob).toLocaleDateString('fr-FR') : '';
    profilUsername.textContent = user.username || '';
    profilePic.src = user.photo || "https://via.placeholder.com/150";
}

// ========================================
// POPUP MODIFIER PROFIL
// ========================================
editProfileBtn.onclick = () => {
    if (!currentUser) return;
    
    editPopup.style.display = 'flex';
    document.getElementById('editPrenom').value = currentUser.prenom || '';
    document.getElementById('editNom').value = currentUser.nom || '';
    document.getElementById('editEmail').value = currentUser.email || '';
    document.getElementById('editDob').value = currentUser.dob || '';
    document.getElementById('editPassword').value = '';
    editPhotoInput.value = '';
};

closePopup.onclick = () => { 
    editPopup.style.display = 'none'; 
};

// ========================================
// PRÉVISUALISATION PHOTO
// ========================================
editPhotoInput.onchange = function(e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(evt) { 
            profilePic.src = evt.target.result; 
        };
        reader.readAsDataURL(file);
    }
};

// ========================================
// ENREGISTRER MODIFICATIONS
// ========================================
editForm.onsubmit = async (e) => {
    e.preventDefault();
    if (!currentUser) return;

    const updates = {};
    
    const newPrenom = document.getElementById('editPrenom').value.trim();
    const newNom = document.getElementById('editNom').value.trim();
    const newEmail = document.getElementById('editEmail').value.trim();
    const newDob = document.getElementById('editDob').value;
    const newPassword = document.getElementById('editPassword').value.trim();

    if (newPrenom) updates.prenom = newPrenom;
    if (newNom) updates.nom = newNom;
    if (newEmail) updates.email = newEmail;
    if (newDob) updates.dob = newDob;
    if (newPassword) updates.password = newPassword;

    // Gestion de la photo
    const file = editPhotoInput.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = async function(evt) {
            updates.photo = evt.target.result;
            await saveProfile(updates);
        };
        reader.readAsDataURL(file);
    } else {
        await saveProfile(updates);
    }
};

async function saveProfile(updates) {
    try {
        const { data, error } = await supabase
            .from('users')
            .update(updates)
            .eq('id', currentUser.id)
            .select();

        if (error) {
            console.error('Erreur mise à jour:', error);
            alert('Erreur lors de la mise à jour du profil');
            return;
        }

        alert('Profil mis à jour avec succès !');
        editPopup.style.display = 'none';
        await loadUserProfile(); // Recharger le profil

    } catch (err) {
        console.error('Erreur:', err);
        alert('Erreur lors de la mise à jour du profil');
    }
}

// ========================================
// DÉCONNEXION
// ========================================
logoutBtnProfile.onclick = () => {
    sessionStorage.removeItem('connectedUserId');
    window.location.href = "index.html";
};

// ========================================
// CONNEXION VIA POPUP
// ========================================
document.getElementById('loginPopupForm').onsubmit = async (e) => {
    e.preventDefault();
    
    const username = document.getElementById('popupUsername').value.trim();
    const password = document.getElementById('popupPassword').value.trim();

    try {
        const { data: user, error } = await supabase
            .from('users')
            .select('*')
            .eq('username', username)
            .single();

        if (error || !user) {
            alert('Utilisateur non trouvé !');
            return;
        }

        if (user.password !== password) {
            alert('Mot de passe incorrect !');
            return;
        }

        if (user.banned) {
            alert('Votre compte a été banni !');
            return;
        }

        sessionStorage.setItem('connectedUserId', user.id);
        currentUser = user;
        loginPopup.style.display = 'none';
        updateProfileDisplay(user);

    } catch (err) {
        console.error('Erreur connexion:', err);
        alert('Erreur lors de la connexion');
    }
};

// ========================================
// CHARGEMENT INITIAL
// ========================================
window.onload = async () => {
    await loadUserProfile();
};
</script>

</body>
</html>

