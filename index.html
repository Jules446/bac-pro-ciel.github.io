<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BAC PRO CIEL - Menu déroulant</title>
<!-- Police Comic Sans web pour compatibilité mobile -->
<link href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@400;700&display=swap" rel="stylesheet">
<!-- Supabase JS -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
* { font-family: 'Comic Neue', cursive, sans-serif !important; margin:0; padding:0; box-sizing:border-box; }
body { background: linear-gradient(#a6d6f7, #5c69d6, #0a1530); color:#fff; min-height:100vh; }
h1 { text-align:center; margin:50px 0 20px; font-size:6vw; letter-spacing:5px; }
h2 { text-align:center; margin:10px 0 40px; font-size:4vw; }

/* Menu déroulant */
.menu-bar { background:#4a66ff; padding:15px 10px; box-shadow:0 5px 15px rgba(0,0,0,0.3); }
.menu-bar ul { list-style:none; display:flex; gap:15px; flex-wrap:wrap; justify-content:center; }
.menu-bar li { position:relative; }
.menu-bar a { color:white; text-decoration:none; padding:10px 20px; display:block; border-radius:20px; font-size:16px; font-weight:bold; transition:0.3s; box-shadow:0 3px 8px rgba(0,0,0,0.2);}
.menu-bar a:hover { background:linear-gradient(135deg,#6e82ff,#8aa0ff); box-shadow:0 5px 15px rgba(0,0,0,0.3);}
.dropdown-content { display:none; position:absolute; top:100%; left:0; background:linear-gradient(#3550ff,#2c3b85); min-width:180px; border-radius:12px; overflow:hidden; z-index:1000; box-shadow:0 5px 15px rgba(0,0,0,0.5);}
.dropdown-content a { padding:10px 15px; font-size:15px; }
.dropdown:hover .dropdown-content { display:block; }
.menu-bar li.dropdown:hover > a { background:linear-gradient(135deg,#6e82ff,#8aa0ff); }

/* Boutons Compte/Admin */
#profilBtn, #deleteAccountBtn, #logoutBtn, #adminLink { display:none; font-size:16px; }
#userDisplay { text-align:center; font-size:18px; margin-top:15px; font-weight:bold; }

/* PC animé */
.pc-image { width:80%; max-width:800px; display:block; margin:30px auto; animation: glow 2s infinite alternate; }
@keyframes glow {
  0% { filter: drop-shadow(0 0 20px #b266ff) drop-shadow(0 0 40px #8f33ff) drop-shadow(0 0 70px #c266ff);}
  50% { filter: drop-shadow(0 0 40px #b266ff) drop-shadow(0 0 60px #8f33ff) drop-shadow(0 0 120px #c266ff);}
  100% { filter: drop-shadow(0 0 20px #b266ff) drop-shadow(0 0 40px #8f33ff) drop-shadow(0 0 70px #c266ff);}
}

/* Popups */
.login-popup { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.8); justify-content:center; align-items:center; z-index:10000; }
.login-popup form { 
    background:#0f1a3a; 
    padding:20px 25px;
    border-radius:25px; 
    width:90%; 
    max-width:450px; 
    max-height:80vh;
    overflow-y:auto;
    display:flex; 
    flex-direction:column; 
    gap:10px;
    box-shadow:0 0 35px #4a66ff; 
}
.login-popup input { 
    padding:10px 12px; 
    border-radius:16px; 
    border:none; 
    font-size:16px; 
}
.password-box { display:flex; align-items:center; gap:10px; }
.password-box button { background:#4a66ff; border:none; border-radius:20px; padding:10px; cursor:pointer; color:white; font-weight:bold; }
.login-popup button.submit { background:#6e82ff; color:white; border:none; padding:12px; border-radius:25px; font-size:16px; cursor:pointer; transition:0.3s; }
.login-popup button.submit:hover { background:#8aa0ff; }
.login-popup button.close { background:#2c3b85; color:white; border:none; padding:10px; border-radius:25px; cursor:pointer; font-size:14px; }

/* Responsive menu mobile */
@media(max-width:600px){
    .menu-bar ul { flex-direction:column; align-items:center; gap:10px; }
    .menu-bar a { padding:8px 15px; font-size:14px; }
    h1 { font-size:8vw; }
    h2 { font-size:5vw; }
}
</style>
</head>
<body>

<header class="menu-bar">
<ul>
    <li class="dropdown">
        <a href="index.html">menu</a>
        <div class="dropdown-content">
            <a href="Cybersécurité.html">Cybersécurité</a>
            <a href="informatique.html">Informatique</a>
            <a href="éléctronique.html">Électronique</a>
        </div>
    </li>
    <li class="dropdown">
        <a href="profil.html">Compte</a>
        <div class="dropdown-content">
            <a href="#" id="signupBtn">Créer un compte</a>
            <a href="#" id="loginBtn">Connexion</a>
            <a href="profil.html" id="profilBtn">Profil</a>
            <a href="#" id="deleteAccountBtn">Supprimer mon compte</a>
            <a href="#" id="logoutBtn">Déconnexion</a>
        </div>
    </li>
    <li class="dropdown">
        <a href="#" id="adminLink">Admin</a>
        <div class="dropdown-content">
            <a href="gestionnair des membre.html">Gestion des membres</a>
        </div>
    </li>
    <li class="dropdown">
        <a href="#">Information</a>
        <div class="dropdown-content">
            <a href="actualité.html">Cybersécurité</a>
        </div>
    </li>
</ul>
</header>

<h1>BAC PRO CIEL</h1>
<h2>Tout ce que tu dois savoir sur le Bac Pro CIEL</h2>
<div id="userDisplay"></div>
<img src="Design_sans_titre-removebg-preview.png" class="pc-image" alt="PC">

<!-- Popup Connexion -->
<div class="login-popup" id="loginForm">
<form id="formLogin">
<h2>Connexion</h2>
<input type="text" id="loginUsername" placeholder="Nom d'utilisateur" required>
<div class="password-box">
<input type="password" id="loginPassword" placeholder="Mot de passe" required>
<button type="button" onclick="togglePassword('loginPassword')">Voir</button>
</div>
<button class="submit" type="submit">Se connecter</button>
<button class="close" type="button" onclick="document.getElementById('loginForm').style.display='none'">Fermer</button>
</form>
</div>

<!-- Popup Inscription -->
<div class="login-popup" id="signupForm">
<form id="formSignup">
<h2>Créer un compte</h2>
<input type="text" id="signupPrenom" placeholder="Prénom" required>
<input type="text" id="signupNom" placeholder="Nom" required>
<input type="date" id="signupDob" required>
<input type="email" id="signupEmail" placeholder="Email" required>
<input type="text" id="signupUsername" placeholder="Nom d'utilisateur" required>
<div class="password-box">
<input type="password" id="signupPassword" placeholder="Mot de passe" required>
<button type="button" onclick="togglePassword('signupPassword')">Voir</button>
</div>
<button class="submit" type="submit">Créer le compte</button>
<button class="close" type="button" onclick="document.getElementById('signupForm').style.display='none'">Fermer</button>
</form>
</div>

<script>
// ========================================
// CONFIGURATION SUPABASE
// ========================================
const SUPABASE_URL = 'https://TON_URL.supabase.co';
const SUPABASE_KEY = 'TON_ANON_KEY';
const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// ========================================
// RÉFÉRENCES ÉLÉMENTS DOM
// ========================================
const loginBtn = document.getElementById('loginBtn');
const signupBtn = document.getElementById('signupBtn');
const logoutBtn = document.getElementById('logoutBtn');
const profilBtn = document.getElementById('profilBtn');
const deleteAccountBtn = document.getElementById('deleteAccountBtn');
const adminLink = document.getElementById('adminLink');
const userDisplay = document.getElementById('userDisplay');
const loginForm = document.getElementById('loginForm');
const signupForm = document.getElementById('signupForm');

// ========================================
// GESTION DE L'UTILISATEUR CONNECTÉ
// ========================================

// Récupérer l'utilisateur connecté depuis sessionStorage
function getConnectedUser() {
    const userId = sessionStorage.getItem('connectedUserId');
    return userId;
}

// Sauvegarder l'utilisateur connecté
function setConnectedUser(userId) {
    sessionStorage.setItem('connectedUserId', userId);
}

// Supprimer l'utilisateur connecté
function clearConnectedUser() {
    sessionStorage.removeItem('connectedUserId');
}

// Afficher l'interface utilisateur connecté
async function afficherUtilisateur(userId) {
    try {
        // Récupérer les infos de l'utilisateur depuis Supabase
        const { data: user, error } = await supabase
            .from('users')
            .select('*')
            .eq('id', userId)
            .single();

        if (error || !user) {
            console.error('Erreur récupération utilisateur:', error);
            clearConnectedUser();
            return;
        }

        // Vérifier si banni
        if (user.banned) {
            alert("Votre compte a été banni !");
            clearConnectedUser();
            location.reload();
            return;
        }

        // Affichage interface
        loginBtn.style.display = 'none';
        signupBtn.style.display = 'inline-block';
        profilBtn.style.display = 'inline-block';
        deleteAccountBtn.style.display = 'inline-block';
        logoutBtn.style.display = 'inline-block';
        adminLink.style.display = user.role === 'admin' ? 'inline-block' : 'none';
        userDisplay.textContent = `Bienvenue, ${user.prenom} ${user.nom} (${user.role})`;

    } catch (err) {
        console.error('Erreur affichage utilisateur:', err);
    }
}

// ========================================
// TOGGLE MOT DE PASSE
// ========================================
function togglePassword(id) {
    const input = document.getElementById(id);
    input.type = input.type === 'password' ? 'text' : 'password';
}

// ========================================
// CONNEXION
// ========================================
document.getElementById('formLogin').addEventListener('submit', async (e) => {
    e.preventDefault();

    const username = document.getElementById('loginUsername').value.trim();
    const password = document.getElementById('loginPassword').value.trim();

    try {
        // Recherche de l'utilisateur
        const { data: users, error } = await supabase
            .from('users')
            .select('*')
            .eq('username', username)
            .single();

        if (error || !users) {
            alert('Utilisateur inconnu !');
            return;
        }

        // Vérification mot de passe
        if (users.password !== password) {
            alert('Mot de passe incorrect !');
            return;
        }

        // Vérification si banni
        if (users.banned) {
            alert("Votre compte a été banni !");
            return;
        }

        // Connexion réussie
        setConnectedUser(users.id);
        await afficherUtilisateur(users.id);
        loginForm.style.display = 'none';
        alert(`Bienvenue ${users.prenom} !`);

    } catch (err) {
        console.error('Erreur connexion:', err);
        alert('Erreur lors de la connexion');
    }
});

// ========================================
// CRÉATION DE COMPTE
// ========================================
signupBtn.onclick = () => { signupForm.style.display = 'flex'; };

document.getElementById('formSignup').addEventListener('submit', async (e) => {
    e.preventDefault();

    const prenom = document.getElementById('signupPrenom').value.trim();
    const nom = document.getElementById('signupNom').value.trim();
    const dob = document.getElementById('signupDob').value;
    const email = document.getElementById('signupEmail').value.trim();
    const username = document.getElementById('signupUsername').value.trim();
    const password = document.getElementById('signupPassword').value.trim();

    try {
        // Vérifier si l'utilisateur existe déjà
        const { data: existingUser } = await supabase
            .from('users')
            .select('id')
            .eq('username', username)
            .single();

        if (existingUser) {
            alert('Ce nom d\'utilisateur existe déjà !');
            return;
        }

        // Créer le nouvel utilisateur
        const { data, error } = await supabase
            .from('users')
            .insert([{
                prenom: prenom,
                nom: nom,
                dob: dob,
                email: email,
                username: username,
                password: password,
                role: 'client',
                banned: false,
                protected: false
            }])
            .select();

        if (error) {
            console.error('Erreur création compte:', error);
            alert('Erreur lors de la création du compte');
            return;
        }

        alert('Compte créé avec succès ! Vous pouvez maintenant vous connecter.');
        signupForm.style.display = 'none';
        document.getElementById('formSignup').reset();

    } catch (err) {
        console.error('Erreur création compte:', err);
        alert('Erreur lors de la création du compte');
    }
});

// ========================================
// SUPPRESSION DE COMPTE
// ========================================
deleteAccountBtn.onclick = async () => {
    if (!confirm("Êtes-vous sûr de vouloir supprimer votre compte ?")) return;

    const userId = getConnectedUser();
    if (!userId) return;

    try {
        const { error } = await supabase
            .from('users')
            .delete()
            .eq('id', userId);

        if (error) {
            console.error('Erreur suppression:', error);
            alert('Erreur lors de la suppression du compte');
            return;
        }

        alert("Compte supprimé avec succès !");
        clearConnectedUser();
        location.reload();

    } catch (err) {
        console.error('Erreur suppression:', err);
        alert('Erreur lors de la suppression du compte');
    }
};

// ========================================
// DÉCONNEXION
// ========================================
logoutBtn.onclick = () => {
    clearConnectedUser();
    location.reload();
};

// ========================================
// POPUP CONNEXION
// ========================================
loginBtn.onclick = () => loginForm.style.display = 'flex';

// ========================================
// CHARGEMENT INITIAL
// ========================================
window.onload = async () => {
    const userId = getConnectedUser();
    if (userId) {
        await afficherUtilisateur(userId);
    }
};
</script>

</body>
</html>

