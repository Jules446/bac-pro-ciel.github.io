<!DOCTYPE html>
<html lang="fr">
<head>
        <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<meta charset="UTF-8">
<title>Admin - Gestion Membres et Commentaires</title>
<style>
body, input, select, button, h1, h2, p, a {
    font-family: "Comic Neue", "Kristen ITC", "Chalkboard SE", sans-serif;
    margin: 0;
}
body {
    min-height: 100vh;
    background: linear-gradient(#a6d6f7, #5c69d6, #0a1530);
    color: white;
}
header {
    background:#4a66ff; 
    padding:20px 0;
}
.menu {
    display:flex; justify-content:center; gap:20px;
    flex-wrap: wrap;
}
.btn-nav {
    text-decoration:none; color:white;
    padding:10px 25px; border-radius:25px;
    background:#6e82ff; font-weight:bold;
}
.btn-nav:hover { background:#8aa0ff; }

#userDisplay { text-align:center; font-size:24px; margin:20px 0; }

.login-popup {
    display:none;
    position:fixed;
    top:0; left:0;
    width:100%; height:100%;
    background:rgba(0,0,0,0.7);
    justify-content:center;
    align-items:center;
}
.login-popup form {
    background:#1a1a2e;
    padding:20px;
    border-radius:15px;
    display:flex;
    flex-direction:column;
    gap:10px;
    width:300px;
    box-shadow:0 0 20px #4a66ff;
}
.login-popup input, .login-popup select, .login-popup button {
    padding:8px; border-radius:6px; border:none;
}
.login-popup button { background:#4a66ff; color:white; cursor:pointer; }
.login-popup button:hover { background:#6e82ff; }

#messageBox {
    position:fixed; top:20px; right:20px; 
    padding:10px 20px; background:#4a66ff; 
    color:white; border-radius:6px; display:none; 
    z-index:1000; box-shadow:0 0 15px #000;
}

/* --- Menus flottants --- */
.floatingMenu {
    position:fixed;
    top:70px;
    right:20px;
    width:90%;
    max-width:900px;
    height:70%;
    background:#1a1a2e;
    border-radius:15px;
    box-shadow:0 0 20px #4a66ff;
    overflow:auto;
    display:none;
    padding:15px;
    z-index:900;
}
.floatingMenu h2 { text-align:center; margin-bottom:10px; }
.floatingMenu table { width:100%; border-collapse:collapse; text-align:left; }
.floatingMenu th, .floatingMenu td { padding:8px; border-bottom:1px solid #444; }
.floatingMenu th { background:#4a66ff; }
.member-btn, .comment-btn {
    padding:4px 8px; border-radius:4px; border:none;
    background:#4a66ff; color:white; cursor:pointer; margin:1px;
}
.member-btn:hover, .comment-btn:hover { background:#6e82ff; }

#searchContainer { text-align:center; margin-bottom:10px; display:none; }
#searchContainer input { padding:6px; width:50%; border-radius:6px; border:none; }
</style>
</head>
<body>

<header>
   <nav class="menu">
        <a href="index.html" class="btn-nav">Menu</a>
        <a href="#" class="btn-nav" id="loginBtn">Connexion</a>
        <a href="#" class="btn-nav" id="logoutBtn" style="display:none;">Déconnexion</a>
        <a href="#" class="btn-nav" id="membersMenuBtn" style="display:none;">Membres</a>
        <a href="#" class="btn-nav" id="commentsMenuBtn" style="display:none;">Commentaires</a>
    </nav>
</header>

<div id="userDisplay"></div>

<div id="messageBox"></div>

<!-- Popup Connexion -->
<div class="login-popup" id="loginForm">
    <form id="formLogin">
        <h2>Connexion</h2>
        <input type="text" id="loginUsername" placeholder="Nom d'utilisateur" required>
        <input type="password" id="loginPassword" placeholder="Mot de passe" required>
        <button type="submit">Se connecter</button>
        <button type="button" id="closeLogin">Fermer</button>
    </form>
</div>

<!-- Barre recherche -->
<div id="searchContainer">
    <input type="text" id="searchInput" placeholder="Rechercher...">
</div>

<!-- Menu flottant Membres -->
<div class="floatingMenu" id="membersMenu">
    <h2>Gestion des Membres</h2>
    <table>
        <thead>
            <tr>
                <th>Nom d’utilisateur</th>
                <th>Prénom</th>
                <th>Nom</th>
                <th>Email</th>
                <th>Date création</th>
                <th>Mot de passe</th>
                <th>Rôle</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="membersList"></tbody>
    </table>
</div>

<!-- Menu flottant Commentaires -->
<div class="floatingMenu" id="commentsMenu">
    <h2>Gestion des Commentaires</h2>
    <table>
        <thead>
            <tr>
                <th>Utilisateur</th>
                <th>Commentaire</th>
                <th>Date</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="commentsList"></tbody>
    </table>
</div>

<script>
// ========================================
// CONFIGURATION SUPABASE - VERSION CORRIGÉE
// ========================================
const SUPABASE_URL = 'https://bvtzijciriawuajyzovs.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ2dHppamNpcmlhd3Vhanl6b3ZzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5NDM5MzksImV4cCI6MjA4MTUxOTkzOX0.bwECe_OuAKAy-lT73DqTwv91UufDxsgqXxds4sNtRxw'; // ⚠️ Remplacer par votre clé anon
const { createClient } = supabase;
const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// --- Références ---
const loginBtn = document.getElementById("loginBtn");
const logoutBtn = document.getElementById("logoutBtn");
const userDisplay = document.getElementById("userDisplay");
const loginForm = document.getElementById("loginForm");
const closeLogin = document.getElementById("closeLogin");
const membersMenuBtn = document.getElementById("membersMenuBtn");
const commentsMenuBtn = document.getElementById("commentsMenuBtn");
const membersMenu = document.getElementById("membersMenu");
const commentsMenu = document.getElementById("commentsMenu");
const membersList = document.getElementById("membersList");
const commentsList = document.getElementById("commentsList");
const messageBox = document.getElementById("messageBox");
const searchContainer = document.getElementById("searchContainer");
const searchInput = document.getElementById("searchInput");

// --- Message stylé ---
function showMessage(msg, duration=3000){
    messageBox.textContent = msg;
    messageBox.style.display="block";
    setTimeout(()=> messageBox.style.display="none", duration);
}

// --- Utilisateur par défaut ---
if(!localStorage.getItem("SUPERADMIN")){
    localStorage.setItem("SUPERADMIN", JSON.stringify({
        prenom:"Super",
        nom:"Admin",
        username:"SUPERADMIN",
        password:"MASTER",
        role:"admin",
        banned:false,
        createdAt:new Date().toLocaleDateString(),
        protected:true
    }));
}

// --- Connexion ---
loginBtn.onclick = () => loginForm.style.display="flex";
closeLogin.onclick = () => loginForm.style.display="none";

document.getElementById("formLogin").addEventListener("submit", e=>{
    e.preventDefault();
    const username = document.getElementById("loginUsername").value.trim();
    const password = document.getElementById("loginPassword").value.trim();
    const data = localStorage.getItem(username);
    if(!data){ showMessage("Utilisateur inconnu !"); return; }
    const user = JSON.parse(data);
    if(user.banned){ showMessage("Utilisateur banni !"); return; }
    if(user.password !== password){ showMessage("Mot de passe incorrect !"); return; }

    localStorage.setItem("connectedUser", JSON.stringify(user));
    loginForm.style.display="none";
    updateUIAfterLogin(user);
});

// --- Déconnexion ---
logoutBtn.onclick = () => {
    localStorage.removeItem("connectedUser");
    logoutBtn.style.display="none";
    loginBtn.style.display="inline-block";
    membersMenuBtn.style.display="none";
    commentsMenuBtn.style.display="none";
    userDisplay.textContent="";
    membersMenu.style.display="none";
    commentsMenu.style.display="none";
    searchContainer.style.display="none";
}

// --- Mise à jour UI après login ---
function updateUIAfterLogin(user){
    loginBtn.style.display="none";
    logoutBtn.style.display="inline-block";
    userDisplay.textContent = `Bienvenue, ${user.prenom} ${user.nom} (${user.role})`;
    if(user.role==="admin"){
        membersMenuBtn.style.display="inline-block";
        commentsMenuBtn.style.display="inline-block";
        searchContainer.style.display="block";
        loadMembers();
        loadComments();
    }
}

// --- Toggle menus flottants (un seul ouvert) ---
membersMenuBtn.onclick = ()=>{
    commentsMenu.style.display="none";
    membersMenu.style.display = membersMenu.style.display==="block"?"none":"block";
};
commentsMenuBtn.onclick = ()=>{
    membersMenu.style.display="none";
    commentsMenu.style.display = commentsMenu.style.display==="block"?"none":"block";
};

// --- Gestion membres ---
function loadMembers(){
    membersList.innerHTML="";
    Object.keys(localStorage).forEach(key=>{
        try{
            const user = JSON.parse(localStorage.getItem(key));
            if(!user.username) return;
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${user.username}</td>
                <td>${user.prenom}</td>
                <td>${user.nom}</td>
                <td>${user.email||''}</td>
                <td>${user.createdAt||''}</td>
                <td>${user.password}</td>
                <td>
                    <select onchange="changeRole('${user.username}', this.value)" ${user.protected?"disabled":""}>
                        <option value="client" ${user.role==='client'?'selected':''}>Client</option>
                        <option value="admin" ${user.role==='admin'?'selected':''}>Admin</option>
                    </select>
                </td>
                <td>
                    <button class="member-btn" onclick="resetPassword('${user.username}')">MDP</button>
                    <button class="member-btn" onclick="toggleBan('${user.username}')" ${user.protected?"disabled":""}>
                        ${user.banned?"Débannir":"Bannir"}
                    </button>
                    <button class="member-btn" onclick="deleteMember('${user.username}')" ${user.protected?"disabled":""}>Supprimer</button>
                </td>
            `;
            membersList.appendChild(tr);
        }catch(e){}
    });
}

function changeRole(username, role){
    const user = JSON.parse(localStorage.getItem(username));
    if(user.protected) return;
    user.role = role;
    localStorage.setItem(username, JSON.stringify(user));
    loadMembers();
    showMessage(`Rôle de ${username} modifié`);
}
function resetPassword(username){
    const newPass = prompt("Nouveau mot de passe :");
    if(!newPass) return;
    const user = JSON.parse(localStorage.getItem(username));
    user.password = newPass;
    localStorage.setItem(username, JSON.stringify(user));
    loadMembers();
    showMessage(`Mot de passe de ${username} modifié`);
}
function toggleBan(username){
    const user = JSON.parse(localStorage.getItem(username));
    if(user.protected) return;
    user.banned = !user.banned;
    localStorage.setItem(username, JSON.stringify(user));
    loadMembers();
    showMessage(`${username} ${user.banned?"banni":"débanni"}`);
}
function deleteMember(username){
    const user = JSON.parse(localStorage.getItem(username));
    if(user.protected) return;
    if(confirm("Supprimer ce compte ?")){
        localStorage.removeItem(username);
        loadMembers();
        showMessage(`Compte ${username} supprimé`);
    }
}

// --- Gestion commentaires ---
if(!localStorage.getItem("comments")) localStorage.setItem("comments", JSON.stringify([]));

function loadComments(){
    const comments = JSON.parse(localStorage.getItem("comments")||'[]');
    commentsList.innerHTML="";
    comments.forEach((c,i)=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${c.username}</td>
            <td>${c.text}</td>
            <td>${c.date}</td>
            <td>
                <button class="comment-btn" onclick="deleteComment(${i})">Supprimer</button>
                <button class="comment-btn" onclick="toggleComment(${i})">
                    ${c.hidden?"Afficher":"Masquer"}
                </button>
                <button class="comment-btn" onclick="banCommentUser('${c.username}')">Bannir</button>
            </td>
        `;
        commentsList.appendChild(tr);
    });
}

function deleteComment(index){
    const comments = JSON.parse(localStorage.getItem("comments")||'[]');
    comments.splice(index,1);
    localStorage.setItem("comments", JSON.stringify(comments));
    loadComments();
    showMessage("Commentaire supprimé");
}
function toggleComment(index){
    const comments = JSON.parse(localStorage.getItem("comments")||'[]');
    comments[index].hidden = !comments[index].hidden;
    localStorage.setItem("comments", JSON.stringify(comments));
    loadComments();
    showMessage(`Commentaire ${comments[index].hidden?"masqué":"visible"}`);
}
function banCommentUser(username){
    const user = JSON.parse(localStorage.getItem(username));
    if(!user || user.protected) return;
    user.banned = true;
    localStorage.setItem(username, JSON.stringify(user));
    showMessage(`${username} banni`);
    loadMembers();
}

// --- Recherche admin ---
searchInput.addEventListener("input", ()=>{
    const term = searchInput.value.toLowerCase();
    Array.from(membersList.children).forEach(tr=>{
        tr.style.display = Array.from(tr.children).some(td=>td.textContent.toLowerCase().includes(term)) ? "" : "none";
    });
});

// --- Chargement au démarrage ---
window.onload = ()=>{
    const connected = JSON.parse(localStorage.getItem("connectedUser"));
    if(connected) updateUIAfterLogin(connected);
}
</script>
</body>
</html>



