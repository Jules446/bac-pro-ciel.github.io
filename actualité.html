<!DOCTYPE html>
<html lang="fr">
<head>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<meta charset="UTF-8">
<title>Actualit√©s - BAC PRO CIEL</title>
<style>
body {
    font-family:"Comic Sans MS", cursive, sans-serif;
    background: linear-gradient(#a6d6f7, #5c69d6, #0a1530);
    color:white;
    margin:0;
    min-height:100vh;
    line-height:1.6;
}
.menu-bar {
    background:#4a66ff;
    padding:20px;
    box-shadow:0 5px 15px rgba(0,0,0,0.3);
}
.menu-bar ul {
    list-style:none;
    display:flex;
    gap:30px;
    justify-content:center;
    margin:0;
    padding:0;
}
.menu-bar li { position:relative; }
.menu-bar a {
    color:white;
    text-decoration:none;
    padding:15px 25px;
    display:block;
    border-radius:25px;
    font-size:22px;
    font-weight:bold;
    transition:0.3s;
}
.menu-bar a:hover { background:linear-gradient(135deg,#6e82ff,#8aa0ff); }
.dropdown-content {
    display:none;
    position:absolute;
    top:100%;
    left:0;
    background:linear-gradient(#3550ff,#2c3b85);
    min-width:200px;
    border-radius:12px;
    overflow:hidden;
    z-index:1000;
}
.dropdown-content a {
    padding:15px 20px;
    font-size:18px;
}
.dropdown:hover .dropdown-content { display:block; }

/* Grille 2 colonnes */
#newsContainer {
    width: 90%;
    margin: 30px auto;
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 20px;
}
/* News */
.newsItem {
    padding: 15px;
    border-radius: 12px;
    background: #222;
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    position: relative;
}
.newsItem img {
    max-width: 100%;
    max-height: 400px;
    object-fit: cover;
    border-radius: 8px;
    margin-top: 10px;
}
.newsItem h3 { color:#4a66ff; margin-bottom:5px; }
.newsItem p, .newsItem a { color:#ccc; }

/* Bouton Modifier */
.newsItem button {
    margin-top: 10px;
    padding:8px 15px;
    border:none;
    border-radius:10px;
    background:#4a66ff;
    color:white;
    cursor:pointer;
    transition:0.3s;
    font-weight:bold;
}
.newsItem button:hover {
    background:#6e82ff;
}

/* Like button */
.likeNewsBtn {
    position: absolute;
    top: 10px;
    right: 10px;
    background: #4a66ff;
    border: none;
    border-radius: 12px;
    color: white;
    padding: 6px 12px;
    cursor: pointer;
    font-weight: bold;
    display: flex;
    align-items: center;
    gap: 5px;
    transition: 0.3s;
}
.likeNewsBtn:hover {
    background: #6e82ff;
    transform: scale(1.05);
}
.likeNewsBtn.liked {
    background: #22c55e;
    transform: scale(1.1);
}

/* Bulle ajout news */
#addNewsBubble {
    position:fixed;
    bottom:30px;
    right:30px;
    width:60px;
    height:60px;
    background:#4a66ff;
    border-radius:50%;
    display:none;
    justify-content:center;
    align-items:center;
    font-size:30px;
    color:white;
    cursor:pointer;
    box-shadow:0 5px 15px rgba(0,0,0,0.3);
    z-index:1000;
}

/* Popups */
.login-popup {
    display:none;
    position:fixed;
    top:0; left:0;
    width:100%; height:100%;
    background:rgba(0,0,0,0.7);
    justify-content:center;
    align-items:center;
    z-index:2000;
}
.login-popup form {
    background:#111;
    padding:20px;
    border-radius:15px;
    width:400px;
    max-height: 90vh;
    overflow-y: auto;
    display:flex;
    flex-direction:column;
    gap:10px;
}
.login-popup input, .login-popup select, .login-popup textarea, .login-popup button {
    padding:10px; border-radius:8px; border:none; font-size:16px;
}
.login-popup textarea {
    min-height: 100px;
    resize: vertical;
}
.login-popup button {
    background:#4a66ff; color:white; cursor:pointer; transition:0.3s;
}
.login-popup button:hover { background:#6e82ff; }

@media(max-width:768px){
    #newsContainer {
        grid-template-columns: 1fr;
    }
}
</style>
</head>
<body>

<!-- Menu -->
<header class="menu-bar">
  <ul>
    <li class="dropdown">
      <a href="index.html">Menu</a>
      <div class="dropdown-content">
        <a href="Cybers√©curit√©.html">Cybers√©curit√©</a>
        <a href="informatique.html">Informatique</a>
        <a href="√©l√©ctronique.html">√âlectronique</a>
      </div>
    </li>
    <li class="dropdown">
      <a href="#">Compte</a>
      <div class="dropdown-content">
        <a href="#" id="signupBtn">Cr√©er un compte</a>
        <a href="#" id="loginBtn">Connexion</a>
        <a href="#" id="logoutBtn" style="display:none;">D√©connexion</a>
      </div>
    </li>
    <li class="dropdown" id="adminMenu" style="display:none;">
      <a href="#">Admin</a>
      <div class="dropdown-content">
        <a href="#" id="openNewsManager">Gestion des news</a>
      </div>
    </li>
  </ul>
</header>

<h1 style="text-align:center;margin-top:30px;">Actualit√©s</h1>
<div id="newsContainer"></div>

<!-- Bulle ajout news -->
<div id="addNewsBubble">+</div>

<!-- Popup ajout news / modification -->
<div class="login-popup" id="newsPopup">
    <form id="formAddNews">
        <h2 id="newsFormTitle">Nouvelle Actualit√©</h2>
        <input type="text" id="newsTitle" placeholder="Titre de l'actualit√©" required>
        <textarea id="newsDesc" placeholder="Description" required></textarea>
        <input type="file" id="newsImgFile" accept="image/*">
        <input type="text" id="newsImgUrl" placeholder="URL de l'image (optionnel)">
        <input type="text" id="newsUrl" placeholder="URL de redirection (optionnel)">
        <button type="submit">Enregistrer</button>
        <button type="button" id="closeNewsPopup">Annuler</button>
    </form>
</div>

<!-- Popups Connexion / Cr√©ation compte -->
<div class="login-popup" id="loginForm">
    <form id="formLogin">
        <h2>Connexion</h2>
        <input type="text" id="loginUsername" placeholder="Nom d'utilisateur" required>
        <input type="password" id="loginPassword" placeholder="Mot de passe" required>
        <button type="submit">Se connecter</button>
        <button type="button" id="closeLogin">Fermer</button>
    </form>
</div>

<div class="login-popup" id="signupForm">
    <form id="formSignup">
        <h2>Cr√©er un compte</h2>
        <input type="text" id="signupPrenom" placeholder="Pr√©nom" required>
        <input type="text" id="signupNom" placeholder="Nom" required>
        <input type="email" id="signupEmail" placeholder="Email" required>
        <input type="text" id="signupUsername" placeholder="Nom d'utilisateur" required>
        <input type="password" id="signupPassword" placeholder="Mot de passe" required>
        <button type="submit">Cr√©er</button>
        <button type="button" id="closeSignup">Fermer</button>
    </form>
</div>

<script>
// ========================================
// CONFIGURATION SUPABASE
// ========================================
const SUPABASE_URL = 'https://TON_URL.supabase.co';
const SUPABASE_KEY = 'TON_ANON_KEY';
const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// ========================================
// R√âF√âRENCES √âL√âMENTS
// ========================================
const loginBtn = document.getElementById("loginBtn");
const logoutBtn = document.getElementById("logoutBtn");
const loginForm = document.getElementById("loginForm");
const signupForm = document.getElementById("signupForm");
const closeLogin = document.getElementById("closeLogin");
const closeSignup = document.getElementById("closeSignup");
const addNewsBubble = document.getElementById('addNewsBubble');
const newsPopup = document.getElementById('newsPopup');
const closeNewsPopup = document.getElementById('closeNewsPopup');
const formAddNews = document.getElementById('formAddNews');
const newsContainer = document.getElementById('newsContainer');
const newsFormTitle = document.getElementById('newsFormTitle');
const adminMenu = document.getElementById('adminMenu');

let editingId = null;
let currentUser = null;
let isAdmin = false;

// ========================================
// GESTION UTILISATEUR
// ========================================
function getConnectedUserId() {
    return sessionStorage.getItem('connectedUserId');
}

async function loadCurrentUser() {
    const userId = getConnectedUserId();
    if (!userId) {
        isAdmin = false;
        addNewsBubble.style.display = 'none';
        adminMenu.style.display = 'none';
        return;
    }

    try {
        const { data: user, error } = await supabase
            .from('users')
            .select('*')
            .eq('id', userId)
            .single();

        if (error || !user) {
            isAdmin = false;
            currentUser = null;
            return;
        }

        currentUser = user;
        isAdmin = user.role === 'admin';
        
        if (isAdmin) {
            addNewsBubble.style.display = 'flex';
            adminMenu.style.display = 'block';
        }

        loginBtn.style.display = 'none';
        logoutBtn.style.display = 'inline-block';

    } catch (err) {
        console.error('Erreur chargement utilisateur:', err);
    }
}

// ========================================
// POPUPS
// ========================================
loginBtn.addEventListener("click", ()=> loginForm.style.display="flex");
closeLogin.addEventListener("click", ()=> loginForm.style.display="none");
document.getElementById("signupBtn").addEventListener("click", ()=> signupForm.style.display="flex");
closeSignup.addEventListener("click", ()=> signupForm.style.display="none");

// ========================================
// CONNEXION
// ========================================
document.getElementById("formLogin").addEventListener("submit", async function(e){
    e.preventDefault();
    const username = document.getElementById("loginUsername").value.trim();
    const password = document.getElementById("loginPassword").value.trim();

    try {
        const { data: user, error } = await supabase
            .from('users')
            .select('*')
            .eq('username', username)
            .single();

        if(error || !user){ 
            alert("Utilisateur non trouv√© !"); 
            return; 
        }
        
        if(user.password !== password){ 
            alert("Mot de passe incorrect !"); 
            return; 
        }

        if(user.banned){
            alert("Votre compte a √©t√© banni !");
            return;
        }

        sessionStorage.setItem("connectedUserId", user.id);
        alert(`Connexion r√©ussie ! Bienvenue ${user.prenom} ${user.nom}`);
        loginForm.style.display="none";
        await loadCurrentUser();
        loadNews();

    } catch(err){
        console.error('Erreur connexion:', err);
        alert('Erreur lors de la connexion');
    }
});

// ========================================
// INSCRIPTION
// ========================================
document.getElementById("formSignup").addEventListener("submit", async function(e){
    e.preventDefault();
    
    const prenom = document.getElementById("signupPrenom").value.trim();
    const nom = document.getElementById("signupNom").value.trim();
    const email = document.getElementById("signupEmail").value.trim();
    const username = document.getElementById("signupUsername").value.trim();
    const password = document.getElementById("signupPassword").value.trim();

    try {
        // V√©rifier si username existe
        const { data: existing } = await supabase
            .from('users')
            .select('id')
            .eq('username', username)
            .single();

        if(existing){
            alert("Ce nom d'utilisateur existe d√©j√† !");
            return;
        }

        // Cr√©er l'utilisateur
        const { error } = await supabase
            .from('users')
            .insert([{
                prenom,
                nom,
                email,
                username,
                password,
                role: 'client'
            }]);

        if(error){
            console.error('Erreur inscription:', error);
            alert('Erreur lors de la cr√©ation du compte');
            return;
        }

        alert('Compte cr√©√© avec succ√®s !');
        signupForm.style.display = 'none';
        document.getElementById('formSignup').reset();

    } catch(err){
        console.error('Erreur inscription:', err);
        alert('Erreur lors de la cr√©ation du compte');
    }
});

// ========================================
// D√âCONNEXION
// ========================================
logoutBtn.addEventListener("click", ()=>{
    sessionStorage.removeItem("connectedUserId");
    location.reload();
});

// ========================================
// GESTION NEWS
// ========================================
addNewsBubble.addEventListener('click', ()=>{
    if(!isAdmin){ 
        alert("Seuls les admins peuvent ajouter des actualit√©s"); 
        return; 
    }
    newsFormTitle.textContent = "Nouvelle Actualit√©";
    formAddNews.reset();
    editingId = null;
    newsPopup.style.display='flex';
});

closeNewsPopup.addEventListener('click', ()=> newsPopup.style.display='none');

// ========================================
// AJOUTER / MODIFIER NEWS
// ========================================
formAddNews.addEventListener('submit', async (e)=>{
    e.preventDefault();
    if(!isAdmin){ 
        alert("Seuls les admins peuvent modifier/ajouter"); 
        return; 
    }

    const title = document.getElementById('newsTitle').value.trim();
    const desc = document.getElementById('newsDesc').value.trim();
    const fileInput = document.getElementById('newsImgFile');
    const urlInput = document.getElementById('newsImgUrl').value.trim();
    const linkUrl = document.getElementById('newsUrl').value.trim();

    let imgData = '';
    
    if(fileInput.files[0]){
        const reader = new FileReader();
        reader.onload = async function(evt){
            imgData = evt.target.result;
            await saveNewsToSupabase(title, desc, imgData, linkUrl);
        }
        reader.readAsDataURL(fileInput.files[0]);
    } else {
        imgData = urlInput;
        await saveNewsToSupabase(title, desc, imgData, linkUrl);
    }
});

async function saveNewsToSupabase(title, desc, imgData, url){
    try {
        if(editingId){
            // Modification
            const { error } = await supabase
                .from('actualites')
                .update({ 
                    title, 
                    description: desc, 
                    image: imgData, 
                    link: url 
                })
                .eq('id', editingId);
                
            if(error) {
                console.error('Erreur modification:', error);
                alert("Erreur lors de la modification !");
                return;
            }
        } else {
            // Ajout
            const { error } = await supabase
                .from('actualites')
                .insert([{ 
                    title, 
                    description: desc, 
                    image: imgData, 
                    link: url, 
                    author_id: currentUser.id,
                    admin_uid: currentUser.id
                }]);
                
            if(error) {
                console.error('Erreur ajout:', error);
                alert("Erreur lors de l'ajout !");
                return;
            }
        }
        
        newsPopup.style.display='none';
        formAddNews.reset();
        loadNews();
        
    } catch(err){
        console.error('Erreur sauvegarde:', err);
        alert('Erreur lors de la sauvegarde');
    }
}

// ========================================
// AFFICHAGE NEWS
// ========================================
async function loadNews(){
    try {
        const { data: newsList, error } = await supabase
            .from('actualites')
            .select('*')
            .order('created_at', { ascending: false });

        if(error){
            newsContainer.innerHTML = '<p>Erreur de chargement.</p>';
            console.error('Erreur chargement news:', error);
            return;
        }

        newsContainer.innerHTML = '';
        
        if(newsList.length === 0){ 
            newsContainer.innerHTML = '<p style="grid-column: 1/-1; text-align:center;">Aucune actualit√© pour le moment.</p>'; 
            return; 
        }

        for(const item of newsList){
            const likesCount = await getLikesCount(item.id);
            const isLiked = await checkIfLiked(item.id);
            
            const div = document.createElement('div');
            div.className = 'newsItem';
            
            let imgHTML = item.image ? `<img src="${item.image}" alt="image">` : '';
            let linkHTML = item.link ? `<p><a href="${item.link}" target="_blank" style="color:#4a66ff;">Voir l'article</a></p>` : '';
            let modifyButton = isAdmin ? `<button onclick="editNews('${item.id}')">Modifier</button>` : '';
            let likeButton = `
                <button class="likeNewsBtn ${isLiked ? 'liked' : ''}" onclick="toggleLikeNews('${item.id}')">
                    üëç <span id="likes-${item.id}">${likesCount}</span>
                </button>
            `;
            
            div.innerHTML = `
                ${likeButton}
                <h3>${item.title}</h3>
                <p>${item.description}</p>
                ${imgHTML}
                ${linkHTML}
                ${modifyButton}
            `;
            newsContainer.appendChild(div);
        }
        
    } catch(err){
        console.error('Erreur chargement news:', err);
        newsContainer.innerHTML = '<p>Erreur de chargement.</p>';
    }
}

// ========================================
// SYST√àME DE LIKES
// ========================================
async function getLikesCount(newsId) {
    try {
        const { count, error } = await supabase
            .from('actualite_likes')
            .select('*', { count: 'exact', head: true })
            .eq('actualite_id', newsId);
            
        if(error) return 0;
        return count || 0;
    } catch(err){
        return 0;
    }
}

async function checkIfLiked(newsId) {
    const userId = getConnectedUserId();
    if(!userId) return false;
    
    try {
        const { data, error } = await supabase
            .from('actualite_likes')
            .select('id')
            .eq('actualite_id', newsId)
            .eq('user_id', userId)
            .single();
            
        return !!data;
    } catch(err){
        return false;
    }
}

async function toggleLikeNews(newsId) {
    const userId = getConnectedUserId();
    if(!userId){
        alert('Vous devez √™tre connect√© pour liker');
        return;
    }
    
    try {
        const isLiked = await checkIfLiked(newsId);
        
        if(isLiked){
            // Supprimer le like
            const { error } = await supabase
                .from('actualite_likes')
                .delete()
                .eq('actualite_id', newsId)
                .eq('user_id', userId);
                
            if(error) throw error;
        } else {
            // Ajouter le like
            const { error } = await supabase
                .from('actualite_likes')
                .insert([{
                    actualite_id: newsId,
                    user_id: userId
                }]);
                
            if(error) throw error;
        }
        
        // Recharger les news pour mettre √† jour l'affichage
        loadNews();
        
    } catch(err){
        console.error('Erreur like:', err);
        alert('Erreur lors du like');
    }
}

// ========================================
// MODIFIER NEWS
// ========================================
async function editNews(id){
    if(!isAdmin){ 
        alert("Seuls les admins peuvent modifier"); 
        return; 
    }
    
    try {
        const { data: item, error } = await supabase
            .from('actualites')
            .select('*')
            .eq('id', id)
            .single();

        if(error){ 
            alert("Erreur r√©cup√©ration news !"); 
            return; 
        }

        editingId = id;
        newsFormTitle.textContent = "Modifier Actualit√©";
        document.getElementById('newsTitle').value = item.title;
        document.getElementById('newsDesc').value = item.description;
        document.getElementById('newsImgUrl').value = item.image||'';
        document.getElementById('newsUrl').value = item.link||'';
        newsPopup.style.display = 'flex';
        
    } catch(err){
        console.error('Erreur √©dition:', err);
        alert('Erreur lors de la r√©cup√©ration de l\'actualit√©');
    }
}

// ========================================
// CHARGEMENT INITIAL
// ========================================
window.onload = async ()=>{
    await loadCurrentUser();
    loadNews();
};
</script>

</body>
</html>
