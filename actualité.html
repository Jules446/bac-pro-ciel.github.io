<!DOCTYPE html>
<html lang="fr">
<head>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<meta charset="UTF-8">
<title>Actualités - BAC PRO CIEL</title>
<style>
body {
    font-family:"Comic Sans MS", cursive, sans-serif;
    background: linear-gradient(#a6d6f7, #5c69d6, #0a1530);
    color:white;
    margin:0;
    min-height:100vh;
    line-height:1.6;
}
.menu-bar {
    background:#4a66ff;
    padding:20px;
    box-shadow:0 5px 15px rgba(0,0,0,0.3);
}
.menu-bar ul {
    list-style:none;
    display:flex;
    gap:30px;
    justify-content:center;
    margin:0;
    padding:0;
}
.menu-bar li { position:relative; }
.menu-bar a {
    color:white;
    text-decoration:none;
    padding:15px 25px;
    display:block;
    border-radius:25px;
    font-size:22px;
    font-weight:bold;
    transition:0.3s;
}
.menu-bar a:hover { background:linear-gradient(135deg,#6e82ff,#8aa0ff); }
.dropdown-content {
    display:none;
    position:absolute;
    top:100%;
    left:0;
    background:linear-gradient(#3550ff,#2c3b85);
    min-width:200px;
    border-radius:12px;
    overflow:hidden;
    z-index:1000;
}
.dropdown-content a {
    padding:15px 20px;
    font-size:18px;
}
.dropdown:hover .dropdown-content { display:block; }

/* Grille 2 colonnes */
#newsContainer {
    width: 90%;
    margin: 30px auto;
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 20px;
}
/* News */
.newsItem {
    padding: 15px;
    border-radius: 12px;
    background: #222;
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
}
.newsItem img {
    max-width: 100%;
    max-height: 400px;
    object-fit: cover;
    border-radius: 8px;
    margin-top: 10px;
}
.newsItem h3 { color:#4a66ff; margin-bottom:5px; }
.newsItem p, .newsItem a { color:#ccc; }

/* Bouton Modifier */
.newsItem button {
    margin-top: 10px;
    padding:8px 15px;
    border:none;
    border-radius:10px;
    background:#4a66ff;
    color:white;
    cursor:pointer;
    transition:0.3s;
    font-weight:bold;
}
.newsItem button:hover {
    background:#6e82ff;
}

/* Bulle ajout news */
#addNewsBubble {
    position:fixed;
    bottom:30px;
    right:30px;
    width:60px;
    height:60px;
    background:#4a66ff;
    border-radius:50%;
    display:flex;
    justify-content:center;
    align-items:center;
    font-size:30px;
    color:white;
    cursor:pointer;
    box-shadow:0 5px 15px rgba(0,0,0,0.3);
    z-index:1000;
}

/* Popups */
.login-popup {
    display:none;
    position:fixed;
    top:0; left:0;
    width:100%; height:100%;
    background:rgba(0,0,0,0.7);
    justify-content:center;
    align-items:center;
    z-index:2000;
}
.login-popup form {
    background:#111;
    padding:20px;
    border-radius:15px;
    width:400px;
    display:flex;
    flex-direction:column;
    gap:10px;
}
.login-popup input, .login-popup select, .login-popup textarea, .login-popup button {
    padding:10px; border-radius:8px; border:none; font-size:16px;
}
.login-popup button {
    background:#4a66ff; color:white; cursor:pointer; transition:0.3s;
}
.login-popup button:hover { background:#6e82ff; }
</style>
</head>
<body>

<!-- Menu -->
<header class="menu-bar">
  <ul>
    <li class="dropdown">
      <a href="index.html">Menu</a>
      <div class="dropdown-content">
        <a href="Cybersécurité.html">Cybersécurité</a>
        <a href="informatique.html">Informatique</a>
        <a href="éléctronique.html">Électronique</a>
      </div>
    </li>
    <li class="dropdown">
      <a href="#">Compte</a>
      <div class="dropdown-content">
        <a href="#" id="signupBtn">Créer un compte</a>
        <a href="#" id="loginBtn">Connexion</a>
        <a href="#" id="logoutBtn" style="display:none;">Déconnexion</a>
      </div>
    </li>
    <li class="dropdown" id="adminMenu" style="display:none;">
      <a href="#">Admin</a>
      <div class="dropdown-content">
        <a href="#" id="openNewsManager">Gestion des news</a>
      </div>
    </li>
  </ul>
</header>

<h1 style="text-align:center;margin-top:30px;">Actualités</h1>
<div id="newsContainer"></div>

<!-- Bulle ajout news -->
<div id="addNewsBubble">+</div>

<!-- Popup ajout news / modification -->
<div class="login-popup" id="newsPopup">
    <form id="formAddNews">
        <h2 id="newsFormTitle">Nouvelle Actualité</h2>
        <input type="text" id="newsTitle" placeholder="Titre de l'actualité">
        <textarea id="newsDesc" placeholder="Description"></textarea>
        <input type="file" id="newsImgFile" accept="image/*">
        <input type="text" id="newsImgUrl" placeholder="URL de l'image (optionnel)">
        <input type="text" id="newsUrl" placeholder="URL de redirection (optionnel)">
        <button type="submit">Enregistrer</button>
        <button type="button" id="closeNewsPopup">Annuler</button>
    </form>
</div>

<!-- Popups Connexion / Création compte -->
<div class="login-popup" id="loginForm">
    <form id="formLogin">
        <h2>Connexion</h2>
        <input type="text" id="loginUsername" placeholder="Nom d'utilisateur" required>
        <input type="password" id="loginPassword" placeholder="Mot de passe" required>
        <button type="submit">Se connecter</button>
        <button type="button" id="closeLogin">Fermer</button>
    </form>
</div>

<div class="login-popup" id="signupForm">
    <form id="formSignup">
        <h2>Créer un compte</h2>
        <input type="text" id="signupPrenom" placeholder="Prénom" required>
        <input type="text" id="signupNom" placeholder="Nom" required>
        <input type="email" id="signupEmail" placeholder="Email" required>
        <input type="text" id="signupUsername" placeholder="Nom d'utilisateur" required>
        <input type="password" id="signupPassword" placeholder="Mot de passe" required>
        <select id="signupRole">
            <option value="client">Client</option>
            <option value="admin">Admin</option>
        </select>
        <button type="submit">Créer</button>
        <button type="button" id="closeSignup">Fermer</button>
    </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// --- Initialisation Supabase ---
const SUPABASE_URL = 'https://TON_URL.supabase.co';
const SUPABASE_KEY = 'TON_ANON_KEY';
const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// --- Références éléments ---
const loginBtn = document.getElementById("loginBtn");
const logoutBtn = document.getElementById("logoutBtn");
const loginForm = document.getElementById("loginForm");
const signupForm = document.getElementById("signupForm");
const closeLogin = document.getElementById("closeLogin");
const closeSignup = document.getElementById("closeSignup");
const addNewsBubble = document.getElementById('addNewsBubble');
const newsPopup = document.getElementById('newsPopup');
const closeNewsPopup = document.getElementById('closeNewsPopup');
const formAddNews = document.getElementById('formAddNews');
const newsContainer = document.getElementById('newsContainer');
const newsFormTitle = document.getElementById('newsFormTitle');

let editingId = null;
let isAdmin = false;

// --- Popups ---
loginBtn.addEventListener("click", ()=> loginForm.style.display="flex");
closeLogin.addEventListener("click", ()=> loginForm.style.display="none");
document.getElementById("signupBtn").addEventListener("click", ()=> signupForm.style.display="flex");
closeSignup.addEventListener("click", ()=> signupForm.style.display="none");

// --- Connexion ---
document.getElementById("formLogin").addEventListener("submit", async function(e){
    e.preventDefault();
    const username = document.getElementById("loginUsername").value.trim();
    const password = document.getElementById("loginPassword").value.trim();

    // On récupère l'utilisateur depuis Supabase
    let { data: users, error } = await supabase
        .from('users')
        .select('*')
        .eq('username', username)
        .single();

    if(error || !users){ alert("Utilisateur non trouvé !"); return; }
    if(users.password !== password){ alert("Mot de passe incorrect !"); return; }

    sessionStorage.setItem("loggedUser", username);
    alert(`Connexion réussie ! Bienvenue ${users.prenom} ${users.nom}`);
    loginForm.style.display="none";
    loginBtn.style.display="none";
    logoutBtn.style.display="inline-block";

    if(users.role==="admin"){
        document.getElementById('adminMenu').style.display='block';
        addNewsBubble.style.display='flex';
        isAdmin = true;
    } else {
        isAdmin = false;
    }
    loadNews();
});

// --- Déconnexion ---
logoutBtn.addEventListener("click", ()=>{
    sessionStorage.removeItem("loggedUser");
    loginBtn.style.display="inline-block";
    logoutBtn.style.display="none";
    document.getElementById('adminMenu').style.display='none';
    addNewsBubble.style.display='none';
    isAdmin = false;
    loadNews();
});

// --- Bulle ajout news ---
addNewsBubble.addEventListener('click', ()=>{
    newsFormTitle.textContent = "Nouvelle Actualité";
    formAddNews.reset();
    editingId = null;
    newsPopup.style.display='flex';
});
closeNewsPopup.addEventListener('click', ()=> newsPopup.style.display='none');

// --- Ajouter / Modifier news ---
formAddNews.addEventListener('submit', async (e)=>{
    e.preventDefault();
    if(!isAdmin){ alert("Seuls les admins peuvent modifier/ajouter"); return; }

    const title = document.getElementById('newsTitle').value.trim();
    const desc = document.getElementById('newsDesc').value.trim();
    const fileInput = document.getElementById('newsImgFile');
    const urlInput = document.getElementById('newsImgUrl').value.trim();
    const linkUrl = document.getElementById('newsUrl').value.trim();

    if(!title && !desc && !fileInput.files[0] && !urlInput) return alert("Rien à enregistrer !");

    let imgData = '';
    if(fileInput.files[0]){
        const reader = new FileReader();
        reader.onload = async function(evt){
            imgData = evt.target.result;
            await saveNewsToSupabase(title, desc, imgData, linkUrl);
        }
        reader.readAsDataURL(fileInput.files[0]);
    } else {
        imgData = urlInput;
        await saveNewsToSupabase(title, desc, imgData, linkUrl);
    }
});

async function saveNewsToSupabase(title, desc, imgData, url){
    if(editingId){
        // Modification
        const { error } = await supabase
            .from('actualites')
            .update({ title, description: desc, image: imgData, link: url })
            .eq('id', editingId);
        if(error) return alert("Erreur lors de la modification !");
    } else {
        // Ajout
        const { error } = await supabase
            .from('actualites')
            .insert([{ title, description: desc, image: imgData, link: url, created_at: new Date() }]);
        if(error) return alert("Erreur lors de l'ajout !");
    }
    newsPopup.style.display='none';
    formAddNews.reset();
    loadNews();
}

// --- Affichage news ---
async function loadNews(){
    const { data: newsList, error } = await supabase
        .from('actualites')
        .select('*')
        .order('created_at', { ascending: false });

    if(error){
        newsContainer.innerHTML = '<p>Erreur de chargement.</p>';
        return;
    }

    newsContainer.innerHTML = '';
    if(newsList.length === 0){ newsContainer.innerHTML = '<p>Aucune actualité pour le moment.</p>'; return; }

    newsList.forEach(item=>{
        const div = document.createElement('div');
        div.className = 'newsItem';
        let imgHTML = item.image ? `<img src="${item.image}" alt="image">` : '';
        let linkHTML = item.link ? `<p><a href="${item.link}" target="_blank" style="color:#4a66ff;">Voir l'article</a></p>` : '';
        let modifyButton = isAdmin ? `<button onclick="editNews(${item.id})">Modifier</button>` : '';
        div.innerHTML = `
            <h3>${item.title}</h3>
            <p>${item.description}</p>
            ${imgHTML}
            ${linkHTML}
            ${modifyButton}
        `;
        newsContainer.appendChild(div);
    });
}

// --- Modifier news ---
async function editNews(id){
    if(!isAdmin){ alert("Seuls les admins peuvent modifier"); return; }
    const { data: item, error } = await supabase
        .from('actualites')
        .select('*')
        .eq('id', id)
        .single();

    if(error){ alert("Erreur récupération news !"); return; }

    editingId = id;
    newsFormTitle.textContent = "Modifier Actualité";
    document.getElementById('newsTitle').value = item.title;
    document.getElementById('newsDesc').value = item.description;
    document.getElementById('newsImgUrl').value = item.image||'';
    document.getElementById('newsUrl').value = item.link||'';
    newsPopup.style.display = 'flex';
}

// --- Au chargement ---
window.onload = async ()=>{
    const username = sessionStorage.getItem("loggedUser");
    if(username){
        const { data: user, error } = await supabase.from('users').select('*').eq('username', username).single();
        if(user && user.role==="admin"){
            addNewsBubble.style.display='flex';
            document.getElementById('adminMenu').style.display='block';
            isAdmin = true;
        } else {
            addNewsBubble.style.display='none';
            document.getElementById('adminMenu').style.display='none';
            isAdmin = false;
        }
        loginBtn.style.display='none';
        logoutBtn.style.display='inline-block';
    } else {
        addNewsBubble.style.display='none';
        document.getElementById('adminMenu').style.display='none';
        isAdmin = false;
    }
    loadNews();
};
</script>


</body>
</html>


